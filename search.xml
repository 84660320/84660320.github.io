<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>PostgreSQL Postgis 源码安装</title>
    <url>/PostgreSQL/unbutu_PostgreSQL_postgis_install/</url>
    <content><![CDATA[<p>为PostgreSQL 12.3 安装Postgis 2.5.4</p>
<h1 id="postgis-源码下载"><a href="#postgis-源码下载" class="headerlink" title="postgis 源码下载"></a>postgis 源码下载</h1><p>巨慢, 耐心等待吧<br><figure class="highlight angelscript"><table><tr><td class="code"><pre><code class="hljs angelscript"><span class="hljs-symbol">postgres@</span>jintao-ThinkPad-L490:~/download$ wget https:<span class="hljs-comment">//download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz</span><br>-<span class="hljs-number">-2020</span><span class="hljs-number">-08</span><span class="hljs-number">-11</span> <span class="hljs-number">14</span>:<span class="hljs-number">57</span>:<span class="hljs-number">46</span>--  https:<span class="hljs-comment">//download.osgeo.org/postgis/source/postgis-2.5.4.tar.gz</span><br>Resolving download.osgeo.org (download.osgeo.org)... <span class="hljs-number">140.211</span><span class="hljs-number">.15</span><span class="hljs-number">.30</span><br>Connecting to download.osgeo.org (download.osgeo.org)|<span class="hljs-number">140.211</span><span class="hljs-number">.15</span><span class="hljs-number">.30</span>|:<span class="hljs-number">443.</span>.. connected.<br>HTTP request sent, awaiting response... <span class="hljs-number">200</span> OK<br>Length: <span class="hljs-number">16041872</span> (<span class="hljs-number">15</span>M) [application/octet-stream]<br>Saving to: ‘postgis<span class="hljs-number">-2.5</span><span class="hljs-number">.4</span>.tar.gz’<br><br>postgis<span class="hljs-number">-2.5</span><span class="hljs-number">.4</span>.tar.gz       <span class="hljs-number">6</span>%[======&gt;                                                    ]   <span class="hljs-number">1016</span>K  <span class="hljs-number">5.72</span>KB/s    eta <span class="hljs-number">43</span>m <span class="hljs-number">7</span>s<br></code></pre></td></tr></table></figure><br><a href="https://git.osgeo.org/gitea/postgis/postgis/branches/">其他版本下载地址</a><br><a id="more"></a></p>
<h1 id="依赖下载-amp-amp-编译-amp-amp-安装"><a href="#依赖下载-amp-amp-编译-amp-amp-安装" class="headerlink" title="依赖下载 &amp;&amp; 编译 &amp;&amp; 安装"></a>依赖下载 &amp;&amp; 编译 &amp;&amp; 安装</h1><p>安装postgis2.5.4需要对应的包及其版本详见<a href="https://postgis.net/docs/manual-2.5/postgis_installation.html#install_requirements">install_requirements</a></p>
<h2 id="zlib1g-dev和libxml2"><a href="#zlib1g-dev和libxml2" class="headerlink" title="zlib1g-dev和libxml2"></a>zlib1g-dev和libxml2</h2><figure class="highlight q"><table><tr><td class="code"><pre><code class="hljs q">sudo apt-<span class="hljs-built_in">get</span> install zlib1g-<span class="hljs-built_in">dev</span><br>sudo apt-<span class="hljs-built_in">get</span> install libxml2-<span class="hljs-built_in">dev</span><br></code></pre></td></tr></table></figure>
<h2 id="geos"><a href="#geos" class="headerlink" title="geos"></a>geos</h2><p>编译时间很长<br><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">wget http:<span class="hljs-regexp">//</span>download.osgeo.org<span class="hljs-regexp">/geos/g</span>eos-<span class="hljs-number">3.7</span>.<span class="hljs-number">2</span>.tar.bz2<br>tar -jxvf geos-<span class="hljs-number">3.7</span>.<span class="hljs-number">2</span>.tar.bz2<br>cd geos-<span class="hljs-number">3.7</span>.<span class="hljs-number">2</span><br>.<span class="hljs-regexp">/configure prefix=/</span>home<span class="hljs-regexp">/postgres/</span>pg12/geos<br>make -j10<br>make install<br></code></pre></td></tr></table></figure></p>
<h2 id="proj"><a href="#proj" class="headerlink" title="proj"></a>proj</h2><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">wget  http:<span class="hljs-regexp">//</span>download.osgeo.org<span class="hljs-regexp">/proj/</span>proj-<span class="hljs-number">4.9</span>.<span class="hljs-number">2</span>.tar.gz<br>tar -zxvf proj-<span class="hljs-number">4.9</span>.<span class="hljs-number">2</span>.tar.gz<br>cd proj-<span class="hljs-number">4.9</span>.<span class="hljs-number">2</span>/<br>.<span class="hljs-regexp">/configure prefix=/</span>home<span class="hljs-regexp">/postgres/</span>pg12/proj<br>make -j10<br>make install<br></code></pre></td></tr></table></figure>
<h2 id="gdal"><a href="#gdal" class="headerlink" title="gdal"></a>gdal</h2><p>编译时间很长<br><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">wget http:<span class="hljs-regexp">//</span>download.osgeo.org<span class="hljs-regexp">/gdal/</span><span class="hljs-number">2.2</span>.<span class="hljs-number">3</span>/gdal-<span class="hljs-number">2.2</span>.<span class="hljs-number">3</span>.tar.gz<br>tar -zxvf gdal-<span class="hljs-number">2.2</span>.<span class="hljs-number">3</span>.tar.gz<br>cd gdal-<span class="hljs-number">2.2</span>.<span class="hljs-number">3</span><br>.<span class="hljs-regexp">/configure prefix=/</span>home<span class="hljs-regexp">/postgres/</span>pg12/gdal<br>make -j10<br>make install<br></code></pre></td></tr></table></figure></p>
<h2 id="json-c"><a href="#json-c" class="headerlink" title="json-c"></a>json-c</h2><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">wget  https:<span class="hljs-regexp">//</span>s3.amazonaws.com<span class="hljs-regexp">/json-c_releases/</span>releases/json-c-<span class="hljs-number">0.15</span>.tar.gz<br>mkdir build<br>cd build<br>..<span class="hljs-regexp">/cmake-configure --prefix=/</span>home<span class="hljs-regexp">/postgres/</span>pg12/jsonc<br>make -j10<br>make install<br></code></pre></td></tr></table></figure>
<h2 id="protobuf-c"><a href="#protobuf-c" class="headerlink" title="protobuf-c"></a>protobuf-c</h2><p>不是必须, 需要使用ST_AsMVT则需要。<br><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/protocolbuffers/</span>protobuf<span class="hljs-regexp">/releases/</span>download<span class="hljs-regexp">/v3.12.4/</span>protobuf-all-<span class="hljs-number">3.12</span>.<span class="hljs-number">4</span>.tar.gz<br>tar -zxvf protobuf-all-<span class="hljs-number">3.12</span>.<span class="hljs-number">4</span>.tar.gz<br>cd protobuf-all-<span class="hljs-number">3.12</span>.<span class="hljs-number">4</span><br>./configure<br>sudo make -j10<br>sudo make install<br>wget https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/protobuf-c/</span>protobuf-c<span class="hljs-regexp">/archive/</span>v1.<span class="hljs-number">3.3</span>.tar.gz<br>tar -zxvf v1.<span class="hljs-number">3.3</span>.tar.gz<br>sudo vim <span class="hljs-regexp">/etc/</span>ld.so.conf<br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/protobuf-3.11.4/</span>lib<br><span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/protobuf-c-1.3.2/</span>lib<br>export LD_LIBRARY_PATH=<span class="hljs-regexp">/usr/</span>local<span class="hljs-regexp">/lib/</span>:<span class="hljs-variable">$LD_LIBRARY_PATH</span><br>cd protobuf-c-<span class="hljs-number">1.3</span>.<span class="hljs-number">3</span><br>.<span class="hljs-regexp">/configure --prefix=/</span>home<span class="hljs-regexp">/postgres/</span>pg12/protobuf<br>make -j10<br>make install<br></code></pre></td></tr></table></figure></p>
<h1 id="更新动态库"><a href="#更新动态库" class="headerlink" title="更新动态库"></a>更新动态库</h1><p>sudo vim /etc/ld.so.conf 追加以下内容</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/home/</span>postgres<span class="hljs-regexp">/pg12/</span>lib/<br><span class="hljs-regexp">/home/</span>postgres<span class="hljs-regexp">/pg12/</span>jsonc<span class="hljs-regexp">/lib/</span><br><span class="hljs-regexp">/home/</span>postgres<span class="hljs-regexp">/pg12/g</span>eos<span class="hljs-regexp">/lib/</span><br><span class="hljs-regexp">/home/</span>postgres<span class="hljs-regexp">/pg12/</span>proj<span class="hljs-regexp">/lib/</span><br><span class="hljs-regexp">/home/</span>postgres<span class="hljs-regexp">/pg12/g</span>dal<span class="hljs-regexp">/lib/</span><br><span class="hljs-regexp">/home/</span>postgres<span class="hljs-regexp">/pg12/</span>protobuf<span class="hljs-regexp">/lib/</span><br></code></pre></td></tr></table></figure>
<h1 id="Postgis下载-amp-amp-编译-amp-amp-安装"><a href="#Postgis下载-amp-amp-编译-amp-amp-安装" class="headerlink" title="Postgis下载 &amp;&amp; 编译 &amp;&amp; 安装"></a>Postgis下载 &amp;&amp; 编译 &amp;&amp; 安装</h1><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">wget [http:<span class="hljs-regexp">//</span>download.osgeo.org<span class="hljs-regexp">/postgis/</span>source/postgis-<span class="hljs-number">2.5</span>.<span class="hljs-number">4</span>.tar.gz<br>tar -zxvf postgis-<span class="hljs-number">2.5</span>.<span class="hljs-number">4</span>.tar.gz<br>cd postgis-<span class="hljs-number">2.5</span>.<span class="hljs-number">4</span><br>.<span class="hljs-regexp">/configure --with-pgconfig=/</span>home<span class="hljs-regexp">/postgres/</span>pg12<span class="hljs-regexp">/bin/</span>pg_config --with-xml2config=<span class="hljs-regexp">/usr/</span>bin<span class="hljs-regexp">/xml2-config --with-geosconfig=/</span>home<span class="hljs-regexp">/postgres/</span>pg12<span class="hljs-regexp">/geos/</span>bin<span class="hljs-regexp">/geos-config --with-gdalconfig=/</span>home<span class="hljs-regexp">/postgres/</span>pg12<span class="hljs-regexp">/gdal/</span>bin<span class="hljs-regexp">/gdal-config --with-projdir=/</span>home<span class="hljs-regexp">/postgres/</span>pg12<span class="hljs-regexp">/proj  --with-jsondir=/</span>home<span class="hljs-regexp">/postgres/</span>pg12<span class="hljs-regexp">/jsonc --with-protobufdir=/</span>home<span class="hljs-regexp">/postgres/</span>pg12/protobuf --with-gui --with-topology --with-raster<br>make -j10 <br>make install <br></code></pre></td></tr></table></figure>
<h1 id="创建extension"><a href="#创建extension" class="headerlink" title="创建extension"></a>创建extension</h1><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">postgres@jintao-ThinkPad-L490:~/download/postgis-2.5.4$ psql<br>psql (12.3)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> help.<br><br><span class="hljs-attribute">postgres</span>=# create extension postgis;<br>CREATE EXTENSION<br><span class="hljs-attribute">postgres</span>=# create extension postgis_t;<br>postgis_tiger_geocoder  postgis_topology<br><span class="hljs-attribute">postgres</span>=# create extension postgis_tiger_geocoder;<br>ERROR:  required extension <span class="hljs-string">&quot;fuzzystrmatch&quot;</span> is <span class="hljs-keyword">not</span> installed<br>HINT:  Use CREATE EXTENSION <span class="hljs-built_in">..</span>. CASCADE <span class="hljs-keyword">to</span> install required extensions too.<br><span class="hljs-attribute">postgres</span>=# create extension postgis_tiger_geocoder cascade;<br>NOTICE:  installing required extension <span class="hljs-string">&quot;fuzzystrmatch&quot;</span><br>CREATE EXTENSION<br><span class="hljs-attribute">postgres</span>=# create extension postgis_topology;<br>postgis_topology<br><span class="hljs-attribute">postgres</span>=# create extension postgis_topology;<br>CREATE EXTENSION<br><span class="hljs-attribute">postgres</span>=# \dx<br>                                            List of installed extensions<br>          Name          | Version |   Schema   |                             Description<br>------------------------+---------+------------+---------------------------------------------------------------------<br> fuzzystrmatch          | 1.1     | public     | determine similarities <span class="hljs-keyword">and</span> distance between strings<br> plpgsql                | 1.0     | pg_catalog | PL/pgSQL procedural language<br> postgis                | 2.5.4   | public     | PostGIS geometry, geography, <span class="hljs-keyword">and</span> raster spatial types <span class="hljs-keyword">and</span> functions<br> postgis_tiger_geocoder | 2.5.4   | tiger      | PostGIS tiger geocoder <span class="hljs-keyword">and</span> reverse geocoder<br> postgis_topology       | 2.5.4   | topology   | PostGIS topology spatial types <span class="hljs-keyword">and</span> functions<br>(5 rows)<br><br><span class="hljs-attribute">postgres</span>=# select postgis_full_version();<br>                                                                                                   postgis_full_version<br><br>-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>-------<br> <span class="hljs-attribute">POSTGIS</span>=<span class="hljs-string">&quot;2.5.4&quot;</span> [EXTENSION] <span class="hljs-attribute">PGSQL</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attribute">GEOS</span>=<span class="hljs-string">&quot;3.7.2-CAPI-1.11.2 b55d2125&quot;</span> <span class="hljs-attribute">PROJ</span>=<span class="hljs-string">&quot;Rel. 4.9.2, 08 September 2015&quot;</span> <span class="hljs-attribute">GDAL</span>=<span class="hljs-string">&quot;GDAL 2.2.3, released 2017/11/20&quot;</span> <span class="hljs-attribute">LIBXML</span>=<span class="hljs-string">&quot;2.9.10&quot;</span> <span class="hljs-attribute">LIBJSON</span>=<span class="hljs-string">&quot;0.15&quot;</span> <span class="hljs-attribute">LIBPROTOBUF</span>=<span class="hljs-string">&quot;1.3.3&quot;</span> TOPOLOGY<br>RASTER<br>(1 row)<br><br><span class="hljs-attribute">postgres</span>=#<br><span class="hljs-attribute">postgres</span>=# select st_geographyfromtext(<span class="hljs-string">&#x27;SRID=4326;POINT(121 23)&#x27;</span>);<br>                st_geographyfromtext<br>----------------------------------------------------<br> 0101000020E61000000000000000405E400000000000003740<br>(1 row)<br><br><span class="hljs-attribute">postgres</span>=#<br></code></pre></td></tr></table></figure>
<p><strong>Note:</strong><br>最新的CREATE EXTENSION 详见 <a href="http://postgis.net/install/">http://postgis.net/install/</a></p>
]]></content>
      <categories>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>postgres</tag>
        <tag>pg</tag>
        <tag>postgresql</tag>
        <tag>PostgreSQL</tag>
        <tag>postgis</tag>
        <tag>geo</tag>
        <tag>gis</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux ubuntu postgresql 源码搭建主从</title>
    <url>/PostgreSQL/PostgreSQL_install_from_source/</url>
    <content><![CDATA[<h1 id="搭建主节点PostgreSQL实例"><a href="#搭建主节点PostgreSQL实例" class="headerlink" title="搭建主节点PostgreSQL实例"></a>搭建主节点PostgreSQL实例</h1><h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><a href="https://www.postgresql.org/ftp/source/v12.3/">官网下载地址</a></p>
<figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">sudo groupadd postgres<br>sudo useradd -a -G postgres postgres<br>su - postgres<br>wget https:<span class="hljs-regexp">//</span>ftp.postgresql.org<span class="hljs-regexp">/pub/</span>source<span class="hljs-regexp">/v12.3/</span>postgresql-<span class="hljs-number">12.3</span>.tar.gz<br></code></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="解压-amp-amp-编译-amp-amp-安装"><a href="#解压-amp-amp-编译-amp-amp-安装" class="headerlink" title="解压 &amp;&amp; 编译 &amp;&amp; 安装"></a>解压 &amp;&amp; 编译 &amp;&amp; 安装</h2><p>需要带哪些编译选项看个人需求<br><figure class="highlight flix"><table><tr><td class="code"><pre><code class="hljs flix">tar -zxvf postgresql<span class="hljs-number">-12.3</span>.tar.gz<br>cd postgresql<span class="hljs-number">-12.3</span><br>./configure CFLAGS=-O0 -g<span class="hljs-string">&#x27; &#x27;</span>--prefix=/home/postgres/pg12<span class="hljs-string">&#x27; &#x27;</span>--<span class="hljs-keyword">with</span>-perl<span class="hljs-string">&#x27; &#x27;</span>--<span class="hljs-keyword">with</span>-libxml<span class="hljs-string">&#x27; &#x27;</span>--<span class="hljs-keyword">with</span>-libxslt<span class="hljs-string">&#x27; &#x27;</span>--<span class="hljs-keyword">with</span>-ossp-uuid<span class="hljs-string">&#x27; &#x27;</span>--<span class="hljs-keyword">with</span>-blocksize=<span class="hljs-number">32</span><span class="hljs-string">&#x27; &#x27;</span>--<span class="hljs-keyword">with</span>-segsize=<span class="hljs-number">2</span><span class="hljs-string">&#x27; &#x27;</span>--<span class="hljs-keyword">with</span>-wal-blocksize=<span class="hljs-number">64</span><span class="hljs-string">&#x27; &#x27;</span>--<span class="hljs-keyword">with</span>-llvm&#x27; --<span class="hljs-keyword">with</span>-python<br><br>make -j10 world       # 带插件一起编译<br>make install-world    # 带插件一起安装<br><br></code></pre></td></tr></table></figure><br>make install-world 出现下面内容时， 即为成功<br><figure class="highlight mipsasm"><table><tr><td class="code"><pre><code class="hljs mipsasm">PostgreSQL, contrib, <span class="hljs-keyword">and </span>documentation <span class="hljs-keyword">installation </span>complete.<br></code></pre></td></tr></table></figure></p>
<h2 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><p>vim ~/.bashrc 追加如下内容<br><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PGHOME</span>=/home/postgres/pg12<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PGDATA</span>=/home/postgres/pg120_data<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PGUSER</span>=postgres<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PGPORT</span>=5432<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PGDATABASE</span>=postgres<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">LD_LIBRARY_PATH</span>=/home/postgres/pg12/lib:$LD_LIBRARY_PATH<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">PATH</span>=/home/postgres/pg12/bin:$PATH<br><br></code></pre></td></tr></table></figure></p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">postgres@pgserver1:~/postgresql-12.3$ initdb<br>The files belonging <span class="hljs-keyword">to</span> this database<span class="hljs-built_in"> system </span>will be owned by<span class="hljs-built_in"> user </span><span class="hljs-string">&quot;postgres&quot;</span>.<br>This<span class="hljs-built_in"> user </span>must also own the<span class="hljs-built_in"> server </span>process.<br><br>The database cluster will be initialized with locales<br>  COLLATE:  en_US.UTF-8<br>  CTYPE:    en_US.UTF-8<br>  MESSAGES: en_US.UTF-8<br>  MONETARY: zh_CN.UTF-8<br>  NUMERIC:  zh_CN.UTF-8<br>  TIME:     zh_CN.UTF-8<br>The<span class="hljs-built_in"> default </span>database encoding has accordingly been <span class="hljs-builtin-name">set</span> <span class="hljs-keyword">to</span> <span class="hljs-string">&quot;UTF8&quot;</span>.<br>The<span class="hljs-built_in"> default </span>text search configuration will be <span class="hljs-builtin-name">set</span> <span class="hljs-keyword">to</span> <span class="hljs-string">&quot;english&quot;</span>.<br><br>Data<span class="hljs-built_in"> page </span>checksums are disabled.<br><br>creating directory /home/postgres/pg120_data <span class="hljs-built_in">..</span>. ok<br>creating subdirectories <span class="hljs-built_in">..</span>. ok<br>selecting dynamic shared memory implementation <span class="hljs-built_in">..</span>. posix<br>selecting<span class="hljs-built_in"> default </span>max_connections <span class="hljs-built_in">..</span>. 100<br>selecting<span class="hljs-built_in"> default </span>shared_buffers <span class="hljs-built_in">..</span>. 128MB<br>selecting<span class="hljs-built_in"> default </span>time zone <span class="hljs-built_in">..</span>. Asia/Shanghai<br>creating configuration files <span class="hljs-built_in">..</span>. ok<br>running bootstrap<span class="hljs-built_in"> script </span><span class="hljs-built_in">..</span>. ok<br>performing post-bootstrap initialization <span class="hljs-built_in">..</span>. ok<br>syncing data <span class="hljs-keyword">to</span> disk <span class="hljs-built_in">..</span>. ok<br><br>initdb: warning: enabling <span class="hljs-string">&quot;trust&quot;</span> authentication <span class="hljs-keyword">for</span> local connections<br>You can change this by editing pg_hba.conf <span class="hljs-keyword">or</span> using the option -A, <span class="hljs-keyword">or</span><br>--auth-local <span class="hljs-keyword">and</span> --auth-host, the next time you <span class="hljs-builtin-name">run</span> initdb.<br><br>Success. You can now start the database<span class="hljs-built_in"> server </span>using:<br><br>    pg_ctl -D /home/postgres/pg120_data -l logfile start<br><br></code></pre></td></tr></table></figure>
<h2 id="修改参数-记录数据库日志"><a href="#修改参数-记录数据库日志" class="headerlink" title="修改参数, 记录数据库日志"></a>修改参数, 记录数据库日志</h2><figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">listen_addresses</span> = <span class="hljs-string">&#x27;*&#x27;</span>          <span class="hljs-comment"># what IP address(es) to listen on;</span><br>                                        <span class="hljs-comment"># comma-separated list of addresses;</span><br>                                        <span class="hljs-comment"># defaults to &#x27;localhost&#x27;; use &#x27;*&#x27; for all</span><br>                                        <span class="hljs-comment"># (change requires restart)</span><br><span class="hljs-attr">port</span> = <span class="hljs-number">5432</span>                             <span class="hljs-comment"># (change requires restart)</span><br><br><span class="hljs-attr">logging_collector</span> = <span class="hljs-literal">on</span>          <span class="hljs-comment"># Enable capturing of stderr and csvlog</span><br>                                        <span class="hljs-comment"># into log files. Required to be on for</span><br>                                        <span class="hljs-comment"># csvlogs.</span><br>                                        <span class="hljs-comment"># (change requires restart)</span><br><br><span class="hljs-comment"># These are only used if logging_collector is on:</span><br><span class="hljs-attr">log_directory</span> = <span class="hljs-string">&#x27;log&#x27;</span>                   <span class="hljs-comment"># directory where log files are written,</span><br>                                        <span class="hljs-comment"># can be absolute or relative to PGDATA</span><br><span class="hljs-attr">log_filename</span> = <span class="hljs-string">&#x27;postgresql-%a.log&#x27;</span>      <span class="hljs-comment"># log file name pattern,</span><br>                                        <span class="hljs-comment"># can include strftime() escapes</span><br><span class="hljs-comment">#log_file_mode = 0600                   # creation mode for log files,</span><br>                                        <span class="hljs-comment"># begin with 0 to use octal notation</span><br><span class="hljs-attr">log_truncate_on_rotation</span> = <span class="hljs-literal">on</span>           <span class="hljs-comment"># If on, an existing log file with the</span><br>                                        <span class="hljs-comment"># same name as the new log file will be</span><br>                                        <span class="hljs-comment"># truncated rather than appended to.</span><br>                                        <span class="hljs-comment"># But such truncation only occurs on</span><br>                                        <span class="hljs-comment"># time-driven rotation, not on restarts</span><br>                                        <span class="hljs-comment"># or size-driven rotation.  Default is</span><br>                                        <span class="hljs-comment"># off, meaning append to existing files</span><br></code></pre></td></tr></table></figure>
<h2 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h2><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">postgres@pgserver1:~/postgresql-12.3$ pg_ctl start<br>waiting <span class="hljs-keyword">for</span><span class="hljs-built_in"> server </span><span class="hljs-keyword">to</span> start<span class="hljs-built_in">..</span><span class="hljs-built_in">..</span>2020-08-11 14:39:44.004 CST [3608866] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit<br>2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on IPv4<span class="hljs-built_in"> address </span><span class="hljs-string">&quot;0.0.0.0&quot;</span>,<span class="hljs-built_in"> port </span>5432<br>2020-08-11 14:39:44.004 CST [3608866] LOG:  listening on<span class="hljs-built_in"> IPv6 address </span><span class="hljs-string">&quot;::&quot;</span>,<span class="hljs-built_in"> port </span>5432<br>2020-08-11 14:39:44.006 CST [3608866] LOG:  listening on Unix socket <span class="hljs-string">&quot;/tmp/.s.PGSQL.5432&quot;</span><br>2020-08-11 14:39:44.012 CST [3608866] LOG:  redirecting log output <span class="hljs-keyword">to</span><span class="hljs-built_in"> logging </span>collector process<br>2020-08-11 14:39:44.012 CST [3608866] HINT:  Future log output will appear <span class="hljs-keyword">in</span> directory <span class="hljs-string">&quot;log&quot;</span>.<br> done<br>server started<br></code></pre></td></tr></table></figure>
<h1 id="搭建主节点PostgreSQL实例-1"><a href="#搭建主节点PostgreSQL实例-1" class="headerlink" title="搭建主节点PostgreSQL实例"></a>搭建主节点PostgreSQL实例</h1><h2 id="下载-1"><a href="#下载-1" class="headerlink" title="下载"></a>下载</h2><p><strong> 步骤同1.1 </strong></p>
<h2 id="解压-amp-amp-编译-amp-amp-安装-1"><a href="#解压-amp-amp-编译-amp-amp-安装-1" class="headerlink" title="解压 &amp;&amp; 编译 &amp;&amp; 安装"></a>解压 &amp;&amp; 编译 &amp;&amp; 安装</h2><p><strong> 步骤同1.2 </strong></p>
<h2 id="配置环境变量-1"><a href="#配置环境变量-1" class="headerlink" title="配置环境变量"></a>配置环境变量</h2><p><strong> 步骤同1.3 </strong></p>
<h2 id="主节点创建流复制用户"><a href="#主节点创建流复制用户" class="headerlink" title="主节点创建流复制用户"></a>主节点创建流复制用户</h2><p>连接上就表明OK<br><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">postgres@pgserver1:~/postgresql-12.3$ psql<br>psql (12.3)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> help.<br><br><span class="hljs-attribute">postgres</span>=# \! uuidgen<br>7089bae5-c467-492a-a402-aaba388e6826<br><span class="hljs-attribute">postgres</span>=# create<span class="hljs-built_in"> user </span>replicator Replication password <span class="hljs-string">&#x27;7089bae5-c467-492a-a402-aaba388e6826&#x27;</span>;<br>CREATE ROLE<br><span class="hljs-attribute">postgres</span>=#<br></code></pre></td></tr></table></figure></p>
<h2 id="增加用户replicator-ACL"><a href="#增加用户replicator-ACL" class="headerlink" title="增加用户replicator ACL"></a>增加用户replicator ACL</h2><p>主库 vim $PGDATA/pg_hba.conf 新增<br><figure class="highlight gml"><table><tr><td class="code"><pre><code class="hljs gml">host    replication     replicator      <span class="hljs-symbol">x</span>.<span class="hljs-symbol">x</span>.<span class="hljs-symbol">x</span>.<span class="hljs-symbol">x</span>/<span class="hljs-number">32</span>            trust<br></code></pre></td></tr></table></figure></p>
<p>使之生效<br><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">postgres@pgserver1:~$ psql <br>psql (<span class="hljs-number">12.3</span>)<br><span class="hljs-keyword">Type</span> &quot;help&quot; <span class="hljs-keyword">for</span> help.<br><br>postgres=# <span class="hljs-keyword">select</span> pg_reload_conf();<br> pg_reload_conf <br><span class="hljs-comment">----------------</span><br> t<br>(<span class="hljs-number">1</span> <span class="hljs-keyword">row</span>)<br></code></pre></td></tr></table></figure></p>
<h2 id="使用pg-basebackup生成从库数据目录"><a href="#使用pg-basebackup生成从库数据目录" class="headerlink" title="使用pg_basebackup生成从库数据目录"></a>使用pg_basebackup生成从库数据目录</h2><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">postgres@pgserver2:~$ pg_basebackup -D /home/postgres/pg120_data -R -X stream -c fast -P -h pgserver1 -p <span class="hljs-number">5432</span> -Ureplicator<br><span class="hljs-number">65984</span>/<span class="hljs-number">65984</span> kB (<span class="hljs-number">100</span>%), <span class="hljs-number">1</span>/<span class="hljs-number">1</span> <span class="hljs-keyword">tablespace</span><br></code></pre></td></tr></table></figure>
<h2 id="启动从库"><a href="#启动从库" class="headerlink" title="启动从库"></a>启动从库</h2><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">postgres@pgserver2:~$ pg_ctl -D /home/postgres/pg120_data start<br>waiting <span class="hljs-keyword">for</span><span class="hljs-built_in"> server </span><span class="hljs-keyword">to</span> start<span class="hljs-built_in">..</span><span class="hljs-built_in">..</span>2020-08-14 15:12:31.552 CST [817489] LOG:  starting PostgreSQL 12.3 on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 9.3.0-10ubuntu2) 9.3.0, 64-bit<br>2020-08-14 15:12:31.552 CST [817489] LOG:  listening on IPv4<span class="hljs-built_in"> address </span><span class="hljs-string">&quot;x.x.x.x&quot;</span>,<span class="hljs-built_in"> port </span>5432<br>2020-08-14 15:12:31.555 CST [817489] LOG:  listening on Unix socket <span class="hljs-string">&quot;/tmp/.s.PGSQL.5432&quot;</span><br>2020-08-14 15:12:31.566 CST [817489] LOG:  redirecting log output <span class="hljs-keyword">to</span><span class="hljs-built_in"> logging </span>collector process<br>2020-08-14 15:12:31.566 CST [817489] HINT:  Future log output will appear <span class="hljs-keyword">in</span> directory <span class="hljs-string">&quot;log&quot;</span>.<br> done<br>server started<br></code></pre></td></tr></table></figure>
<h2 id="主节点确认流复制"><a href="#主节点确认流复制" class="headerlink" title="主节点确认流复制"></a>主节点确认流复制</h2><figure class="highlight gherkin"><table><tr><td class="code"><pre><code class="hljs gherkin">postgres<span class="hljs-meta">@pgserver1:~$</span> psql <br>psql (12.3)<br>Type <span class="hljs-string">&quot;help&quot;</span> for help.<br>postgres=<span class="hljs-comment"># select * from pg_stat_replication ;</span><br>  pid   |<span class="hljs-string"> usesysid </span>|<span class="hljs-string"> usename  </span>|<span class="hljs-string"> application_name </span>|<span class="hljs-string"> client_addr </span>|<span class="hljs-string"> client_hostname </span>|<span class="hljs-string"> client_port </span>|<span class="hljs-string">         backend_start         </span>|<span class="hljs-string"> backend_xmin </span>|<span class="hljs-string">   state   </span>|<span class="hljs-string"> sent_lsn  </span>|<span class="hljs-string"> write_lsn </span>|<span class="hljs-string"> flush_lsn </span>|<span class="hljs-string"> replay_lsn </span>|<span class="hljs-string">   writ</span><br><span class="hljs-string">e_lag    </span>|<span class="hljs-string">    flush_lag    </span>|<span class="hljs-string">   replay_lag    </span>|<span class="hljs-string"> sync_priority </span>|<span class="hljs-string"> sync_state </span>|<span class="hljs-string">          reply_time           </span><br><span class="hljs-string">--------+----------+----------+------------------+-------------+-----------------+-------------+-------------------------------+--------------+-----------+-----------+-----------+-----------+------------+-------</span><br><span class="hljs-string">---------+-----------------+-----------------+---------------+------------+-------------------------------</span><br><span class="hljs-string"> 817497 </span>|<span class="hljs-string">       10 </span>|<span class="hljs-string"> replicator </span>|<span class="hljs-string"> walreceiver      </span>|<span class="hljs-string"> x.x.x.x   </span>|<span class="hljs-string">                 </span>|<span class="hljs-string">       50850 </span>|<span class="hljs-string"> 2020-08-14 15:12:31.612261+08 </span>|<span class="hljs-string">              </span>|<span class="hljs-string"> streaming </span>|<span class="hljs-string"> 0/4000B60 </span>|<span class="hljs-string"> 0/4000B60 </span>|<span class="hljs-string"> 0/4000B60 </span>|<span class="hljs-string"> 0/4000B60  </span>|<span class="hljs-string"> 00:00:</span><br><span class="hljs-string">00.02204 </span>|<span class="hljs-string"> 00:00:00.022362 </span>|<span class="hljs-string"> 00:00:00.022769 </span>|<span class="hljs-string">             0 </span>|<span class="hljs-string"> async      </span>|<span class="hljs-string"> 2020-08-14 15:12:31.636213+08</span><br><span class="hljs-string">(1 row)</span><br><br><span class="hljs-string">postgres=# </span><br></code></pre></td></tr></table></figure>
<h2 id="从节点确认流复制"><a href="#从节点确认流复制" class="headerlink" title="从节点确认流复制"></a>从节点确认流复制</h2><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">postgres@pgserver2:~$ psql<br>psql (12.3)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> help.<br><br><span class="hljs-attribute">postgres</span>=# select * <span class="hljs-keyword">from</span> pg_stat_wal_receiver ;<br>  pid   |  status   | receive_start_lsn | receive_start_tli | received_lsn | received_tli |      last_msg_send_time       |     last_msg_receipt_time     | latest_end_lsn |        latest_end_time        | slot_n<br>ame | sender_host | sender_port |                                                                                                             conninfo                                                             <br>                                                <br>--------+-----------+-------------------+-------------------+--------------+--------------+-------------------------------+-------------------------------+----------------+-------------------------------+-------<br>----+-------------+-------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br>------------------------------------------------<br> 817496 | streaming | 0/4000000         |                 1 | 0/4000B60    |            1 | 2020-08-14 15:15:01.924922+08 | 2020-08-14 15:15:01.924989+08 | 0/4000B60      | 2020-08-14 15:12:31.613519+08 |       <br>    | x.x.x.x   |        5432 | <span class="hljs-attribute">user</span>=replicator <span class="hljs-attribute">passfile</span>=/home/postgres/.pgpass <span class="hljs-attribute">dbname</span>=replication <span class="hljs-attribute">host</span>=x.x.x.x <span class="hljs-attribute">port</span>=5432 <span class="hljs-attribute">fallback_application_name</span>=walreceiver <span class="hljs-attribute">sslmode</span>=disable <span class="hljs-attribute">sslcompression</span>=0 <span class="hljs-attribute">gssencmode</span>=disab<br>le <span class="hljs-attribute">krbsrvname</span>=replicator <span class="hljs-attribute">target_session_attrs</span>=any<br>(1 row)<br><br><span class="hljs-attribute">postgres</span>=# <br></code></pre></td></tr></table></figure>
<h1 id="结束"><a href="#结束" class="headerlink" title="结束"></a>结束</h1><p>主从搭建so easy.</p>
]]></content>
      <categories>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>postgres</tag>
        <tag>pg</tag>
        <tag>install</tag>
        <tag>source</tag>
        <tag>postgresql</tag>
        <tag>PostgreSQL</tag>
      </tags>
  </entry>
  <entry>
    <title>有用的连接</title>
    <url>/%E4%B8%AA%E4%BA%BA%E8%AE%B0%E5%BD%95/%E9%BA%BB%E9%9B%80/</url>
    <content><![CDATA[<h2 id="生成随即背景图片"><a href="#生成随即背景图片" class="headerlink" title="生成随即背景图片"></a>生成随即背景图片</h2><figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim">http<span class="hljs-variable">s:</span>//<span class="hljs-keyword">source</span>.unsplash.<span class="hljs-keyword">com</span>/<br></code></pre></td></tr></table></figure>
<h2 id="SQL格式化"><a href="#SQL格式化" class="headerlink" title="SQL格式化"></a>SQL格式化</h2><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>sqlformat.darold.net/<br></code></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="PG11中文手册"><a href="#PG11中文手册" class="headerlink" title="PG11中文手册"></a>PG11中文手册</h2><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.docs4dev.com<span class="hljs-regexp">/docs/</span>zh<span class="hljs-regexp">/postgre-sql/</span><span class="hljs-number">11.2</span><span class="hljs-regexp">/reference/</span>release-<span class="hljs-number">11</span>-<span class="hljs-number">2</span>.html<br></code></pre></td></tr></table></figure>
<h2 id="JSON格式化"><a href="#JSON格式化" class="headerlink" title="JSON格式化"></a>JSON格式化</h2><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.json.cn/<br></code></pre></td></tr></table></figure>
<h2 id="PostgreSQL特性矩阵"><a href="#PostgreSQL特性矩阵" class="headerlink" title="PostgreSQL特性矩阵"></a>PostgreSQL特性矩阵</h2><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.postgresql.org<span class="hljs-regexp">/about/</span>featurematrix/<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>个人记录</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>Linux</tag>
        <tag>personal</tag>
      </tags>
  </entry>
  <entry>
    <title>Python小技巧</title>
    <url>/python/Python%E5%B0%8F%E6%8A%80%E5%B7%A7/</url>
    <content><![CDATA[<pre><code>记录一些工作中用到的python小技巧.
</code></pre><a id="more"></a>
<h1 id="list中dict按某一列排序"><a href="#list中dict按某一列排序" class="headerlink" title="list中dict按某一列排序"></a>list中dict按某一列排序</h1><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs Python"><span class="hljs-meta">&gt;&gt;&gt; </span><span class="hljs-keyword">from</span> operator <span class="hljs-keyword">import</span> itemgetter<br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>sorted(result, key=itemgetter(<span class="hljs-string">&#x27;b&#x27;</span>), reverse=<span class="hljs-literal">True</span>)<br>[&#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">5</span>&#125;, &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">5</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">4</span>&#125;, &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">1</span>&#125;, &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">5</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">9</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">0</span>&#125;]<br><span class="hljs-meta">&gt;&gt;&gt; </span>sorted(result, key=itemgetter(<span class="hljs-string">&#x27;b&#x27;</span>))<br>[&#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">5</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">9</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">0</span>&#125;, &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">1</span>&#125;, &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">5</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">4</span>&#125;, &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">5</span>&#125;]<br><span class="hljs-meta">&gt;&gt;&gt; </span>sorted(result, key=itemgetter(<span class="hljs-string">&#x27;b&#x27;</span>))<br>[&#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">5</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">9</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">0</span>&#125;, &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">1</span>&#125;, &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">5</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">4</span>&#125;, &#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">5</span>&#125;]<br>&gt;&gt;&gt;<br></code></pre></td></tr></table></figure>
<h1 id="两个list生成dict"><a href="#两个list生成dict" class="headerlink" title="两个list生成dict"></a>两个list生成dict</h1><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs Python"><span class="hljs-meta">&gt;&gt;&gt; </span>list1=[<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>]<br><span class="hljs-meta">&gt;&gt;&gt; </span>list2=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>]<br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>dict(zip(list1, list2))<br>&#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">2</span>&#125;<br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>dict(zip(list2, list1))<br>&#123;<span class="hljs-number">1</span>: <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">2</span>: <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-number">3</span>: <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-number">4</span>: <span class="hljs-string">&#x27;d&#x27;</span>&#125;<br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>list1=[<span class="hljs-string">&quot;a&quot;</span>,<span class="hljs-string">&quot;b&quot;</span>,<span class="hljs-string">&quot;c&quot;</span>,<span class="hljs-string">&quot;d&quot;</span>]<br><span class="hljs-meta">&gt;&gt;&gt; </span>list2=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>]<br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>dict(zip(list2, list1))<br>&#123;<span class="hljs-number">1</span>: <span class="hljs-string">&#x27;a&#x27;</span>, <span class="hljs-number">2</span>: <span class="hljs-string">&#x27;b&#x27;</span>, <span class="hljs-number">3</span>: <span class="hljs-string">&#x27;c&#x27;</span>, <span class="hljs-number">4</span>: <span class="hljs-string">&#x27;d&#x27;</span>&#125;<br>&gt;&gt;&gt;<br><span class="hljs-meta">&gt;&gt;&gt; </span>dict(zip(list1, list2))<br>&#123;<span class="hljs-string">&#x27;c&#x27;</span>: <span class="hljs-number">3</span>, <span class="hljs-string">&#x27;d&#x27;</span>: <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;a&#x27;</span>: <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;b&#x27;</span>: <span class="hljs-number">2</span>&#125;<br>&gt;&gt;&gt;<br><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>两阶段提交事物</title>
    <url>/PostgreSQL/PostgreSQL%E4%B8%A4%E9%98%B6%E6%AE%B5%E4%BA%8B%E7%89%A9%E6%8F%90%E4%BA%A4/</url>
    <content><![CDATA[<h1 id="什么是两阶段提交事物"><a href="#什么是两阶段提交事物" class="headerlink" title="什么是两阶段提交事物"></a>什么是两阶段提交事物</h1><p>两阶段提交协议的目标在于为分布式系统保证数据的一致性，许多分布式系统采用该协议提供对分布式事务的支持。<br>顾名思义，该协议将一个分布式的事务过程拆分成两个阶段： 准备和事务提交</p>
<a id="more"></a>
<h1 id="PostgreSQL两阶段提交协议"><a href="#PostgreSQL两阶段提交协议" class="headerlink" title="PostgreSQL两阶段提交协议"></a>PostgreSQL两阶段提交协议</h1><pre><code>两阶段提交协议有五个步骤，如下：
</code></pre><ol>
<li>应用程序先调用各台机数据库做一些操作，但不提交事务。然后应用程序调用事务协调器（这个协调器可能也是由应用自己实现）中的提交方法。</li>
<li>事务协调器将联络事务中涉及的每台数据库，并通知它们准备提交事务，这是第一阶段的开始。在PostgreSQL一般是调用“PREPARE TRANSACTION”命令。</li>
<li>各台数据库接收到“PREPARE TRANSACTION”命令后，如果要返回成功，则数据库必须将自己置于以下状态：确保能在被要求提交事务时提交事务，或在被要求回滚事务时回滚事务。所以PostgreSQL会将已准备好提交的信息写入持久存储区中。如果数据库无法完成此事务，它会直接返回失败给事务协调器。</li>
<li>事务协调器接收到了所有数据库的响应。</li>
<li>在第二阶段，如果任一数据库在第一阶段返回失败，则事务协调器会将发一个回滚命令（ROLLBACK PREPARED）给各台数据库。如果所有数据库的响应都是成功的，则向各台数据库发送“COMMIT PREPARED”命令，通知各台数据库事务成功。</li>
</ol>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">mydb</span>=# create table t1(id int, crt_time timestamptz);<br>CREATE TABLE<br><span class="hljs-attribute">mydb</span>=# begin;                                              -- 开启事务<br>BEGIN<br><span class="hljs-attribute">mydb</span>=*# insert into t1 select 1, now();    -- 插入一条数据<br>INSERT 0 1<br><span class="hljs-attribute">mydb</span>=*# prepare transaction <span class="hljs-string">&#x27;p1&#x27;</span>;            -- 准备事务<br>PREPARE TRANSACTION<br><span class="hljs-attribute">mydb</span>=# \q<br>jintao@jintao-ThinkPad-L490:~$ sudo -iu jintao /opt/pg-master/bin/pg_ctl -D /export/pgdata-master/ restart -l /tmp/start.log     -- 重启数据库<br>waiting <span class="hljs-keyword">for</span><span class="hljs-built_in"> server </span><span class="hljs-keyword">to</span> shut down<span class="hljs-built_in">..</span><span class="hljs-built_in">..</span> done<br>server stopped<br>waiting <span class="hljs-keyword">for</span><span class="hljs-built_in"> server </span><span class="hljs-keyword">to</span> start<span class="hljs-built_in">..</span><span class="hljs-built_in">..</span> done<br>server started<br>jintao@jintao-ThinkPad-L490:~$ psql<br>psql (14devel)<br>Type <span class="hljs-string">&quot;help&quot;</span> <span class="hljs-keyword">for</span> help.<br><br><span class="hljs-attribute">mydb</span>=# select * <span class="hljs-keyword">from</span> pg_prepared_xacts ;          -- 查看两阶段事务系统表<br> transaction | gid |           prepared            | owner  | database<br>-------------+-----+-------------------------------+--------+----------<br>        1045 | p1  | 2020-07-15 17:02:07.180102+08 | jintao | mydb<br>(1 row)<br><br><span class="hljs-attribute">mydb</span>=# select * <span class="hljs-keyword">from</span> t1;<br> id | crt_time<br>----+----------<br>(0 rows)<br><br><span class="hljs-attribute">mydb</span>=# commit prepared <span class="hljs-string">&#x27;p1&#x27;</span>;                            -- 提交<br>COMMIT PREPARED<br><span class="hljs-attribute">mydb</span>=# select * <span class="hljs-keyword">from</span> t1;<br> id |           crt_time<br>----+-------------------------------<br>  1 | 2020-07-15 17:01:59.163772+08<br>(1 row)<br><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
        <tag>2pc</tag>
      </tags>
  </entry>
  <entry>
    <title>利用Github分支备份Hexo博客源文件</title>
    <url>/hexo/%E5%88%A9%E7%94%A8Github%E5%88%86%E6%94%AF%E5%A4%87%E4%BB%BDHexo%E5%8D%9A%E5%AE%A2%E6%BA%90%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<h1 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h1><p>Hexo 部署博客很方便，我的这个博客也是用 Hexo 部署在 GitHub Pages 上的，有得人可能在多台电脑上写博客，这个时候需要把博客<br>的源文件备份在一个地方，这样只需把博客源文件复制下来就可以在另一个地方写博客并部署到 GitHub Pages上了.</p>
<p>本篇介绍的就是利用博客的 repo 分支（ master 分支的必须用来存放你博客网站文件）托管 Hexo 源文件和配置达到备份的目的，<br>下面开始正题.</p>
<a id="more"></a>
<h1 id="把博客目录的源文件push到repo分支上"><a href="#把博客目录的源文件push到repo分支上" class="headerlink" title="把博客目录的源文件push到repo分支上"></a>把博客目录的源文件push到repo分支上</h1><p>cd 进入博客目录，Git 初始化：<br><figure class="highlight ebnf"><table><tr><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git init</span><br></code></pre></td></tr></table></figure></p>
<p>完成之后，添加修改的文件，Hexo 就自带了 .gitignore 文件需要忽略的文件 都已经默认配置好了，add 全部文件：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><code class="hljs dockerfile">git <span class="hljs-keyword">add</span><span class="bash"> .</span><br></code></pre></td></tr></table></figure>
<p>然后commit<br><figure class="highlight nginx"><table><tr><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">git</span> commit -m <span class="hljs-string">&quot;commit first time&quot;</span><br></code></pre></td></tr></table></figure></p>
<p>提交成功之后，接下来就是 push 到github了，需要先把这 Hexo 源文件映射到远程 repo 上：<br><figure class="highlight armasm"><table><tr><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">git</span> remote <span class="hljs-keyword">add</span> origin https:<span class="hljs-comment">//github.com/your-name/your-name.github.io.git</span><br></code></pre></td></tr></table></figure></p>
<p>接下来就是把Hexo源文件 push 上去，但是关键的地方到了，master上是 Hexo 生成博客网页的代码，而我们 Hexo 源文件是要 push 到一个分支上面的，所以接下来先要在 repo 上新建一个分支<br>新建一个叫做hexo分支：<br><figure class="highlight ebnf"><table><tr><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git branch hexo</span><br></code></pre></td></tr></table></figure></p>
<p>查看本地分支，并且切换到 hexo 分支<br><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">git</span> <span class="hljs-string">branch</span><br><span class="hljs-attr">git</span> <span class="hljs-string">checkout hexo</span><br></code></pre></td></tr></table></figure></p>
<p>再把刚才添加的 Hexo 源文件代码 push 到hexo这个分支<br><figure class="highlight maxima"><table><tr><td class="code"><pre><code class="hljs maxima">git <span class="hljs-built_in">push</span> -u <span class="hljs-built_in">origin</span> hexo<br></code></pre></td></tr></table></figure></p>
<p>然后就可以在 repo 上看到分支里面已经有博客的源文件了</p>
<h1 id="日常更新博客源文件"><a href="#日常更新博客源文件" class="headerlink" title="日常更新博客源文件"></a>日常更新博客源文件</h1><p>以后你本地的博客源文件的修改就可以直接用 git 命令 push 到 repo 的 hexo 分支上了:<br><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">git add .  <span class="hljs-regexp">//</span>添加修改内容到本地仓储<br>git commit -m <span class="hljs-string">&#x27;modify blog&#x27;</span>  <span class="hljs-regexp">//</span>提交修改内容到本地仓库<br>git push --set-upstream origin hexo <span class="hljs-regexp">//</span>配置push，以方便后期直接git push推送<br>git push  <span class="hljs-regexp">//</span>将本地分支和分支下的内容推送到远程<br><br></code></pre></td></tr></table></figure></p>
<p>注意：执行 git push —set-upstream origin hexo 命令之后，以后修改博客源文件代码之后，直接使用 git push 不用再指定分支，就可以把代码 push 到 hexo 分支上了</p>
<h1 id="更换地点使用-repo-分支上的博客源文件"><a href="#更换地点使用-repo-分支上的博客源文件" class="headerlink" title="更换地点使用 repo 分支上的博客源文件"></a>更换地点使用 repo 分支上的博客源文件</h1><p>换一台电脑，配置好 Hexo 的环境，配置 Git SSH key，把博客源文件代码克隆下来:<br><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">git clone xxxxxxxxx.xx (你的 github<span class="hljs-built_in"> page </span>的 repo 地址)<br></code></pre></td></tr></table></figure></p>
<p>博客源文件下载下来之后，默认的分支是 master，需要切换到 hexo 分支<br><figure class="highlight ebnf"><table><tr><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">git checkout hexo</span><br></code></pre></td></tr></table></figure></p>
<p>然后cd到博客目录依次执行以下命令：<br><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">npm <span class="hljs-keyword">install</span> hexo<br>npm <span class="hljs-keyword">install</span><br>npm <span class="hljs-keyword">install</span> hexo-deployer-git <span class="hljs-comment">--save</span><br></code></pre></td></tr></table></figure></p>
<p>接下来就可以开始愉快的写博客了，写完之后记得把源文件代码 push 到 Github 上，然后用 Hexo 部署到自己博客上面</p>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>github</tag>
      </tags>
  </entry>
  <entry>
    <title>内核Softdog测试</title>
    <url>/Linux/softdog/</url>
    <content><![CDATA[<h1 id="Watchdog的功能"><a href="#Watchdog的功能" class="headerlink" title="Watchdog的功能"></a>Watchdog的功能</h1><pre><code>Linux内核watchdog于监视系统是否正在运行。由于存在不可恢复的软件错误，应该自动重新启动挂起的系统。

看门狗模块特依赖所使用的硬件或芯片。个人计算机用户通常不需要看门狗，因为他们可以手动重置系统。但是，watchdog对于任务关键型系统和需要无需人工干预即可自行重启的系统很有用。
</code></pre><p>例如，需要自动硬件重置功能的远程位置的服务器。</p>
<a id="more"></a>
<h1 id="Watchdog的实现"><a href="#Watchdog的实现" class="headerlink" title="Watchdog的实现"></a>Watchdog的实现</h1><pre><code>看门狗功能设置了一个计时器在预定时间后超时。然后看门狗软件定期喂狗(刷新硬件计时器)。如果停止喂狗，到达设定时间后，将会出现狗咬人(执行设备的硬件重置)。
</code></pre><p>可以分为hardware watchdog 和 software watchdog。<br>    hardware watchdog 是主板芯片的功能。不同的芯片使用不同的模块，例如：Intel 主板使用 “iTCO_wdt”， HP 通常使用 “hpwdt”，IBM 使用 “vmwatchdog”，Xen VM 使用 “xen_wdt”。<br>    software watchdog 是Linux内核提供使用内核计时器实现的软件监视程序。</p>
<h1 id="测试Linux自带watchdog"><a href="#测试Linux自带watchdog" class="headerlink" title="测试Linux自带watchdog"></a>测试Linux自带watchdog</h1><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros">[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件<br>/dev<span class="hljs-built_in">/watchdog </span> /dev/watchdog0<br>[root@server6 ~]# lsmod |grep -i soft            #查看softdog是否加载<br>[root@server6 ~]# modinfo softdog                #查看softdog模块信息<br>filename:       /lib/modules/3.10.0-957.10.1.el7.x86_64/kernel/drivers/watchdog/softdog.ko.xz<br>alias:          char-major-10-130<br>license:        GPL<br>description:    Software<span class="hljs-built_in"> Watchdog </span>Device Driver<br>author:         Alan Cox<br>retpoline:      Y<br>rhelversion:    7.6<br>srcversion:     250C077ED39E75BF25AD8D1<br>depends:<br>intree:         Y<br>vermagic:       3.10.0-957.10.1.el7.x86_64 SMP mod_unload modversions<br>signer:         CentOS Linux kernel signing key<br>sig_key:        17:EA:5F:B9:16:4B:C2:26:55:5C:00:43:FA:D4:E5:86:CC:E8:A2:05<br>sig_hashalgo:   sha256<br>parm:           soft_margin:Watchdog soft_margin <span class="hljs-keyword">in</span> seconds. (0 &lt; soft_margin &lt; 65536, <span class="hljs-attribute">default</span>=60) (uint)<br>parm:           nowayout:Watchdog cannot be stopped once started (<span class="hljs-attribute">default</span>=0) (bool)<br>parm:           soft_noboot:Softdog action, <span class="hljs-builtin-name">set</span> <span class="hljs-keyword">to</span> 1 <span class="hljs-keyword">to</span> ignore reboots, 0 <span class="hljs-keyword">to</span> reboot (<span class="hljs-attribute">default</span>=0) (int)<br>parm:           soft_panic:Softdog action, <span class="hljs-builtin-name">set</span> <span class="hljs-keyword">to</span> 1 <span class="hljs-keyword">to</span> panic, 0 <span class="hljs-keyword">to</span> reboot (<span class="hljs-attribute">default</span>=0) (int)<br><br>[root@server6 ~]# modprobe softdog               #加载softdog 可以设置 soft_margin soft_noboot   soft_panic   nowayout等参数<br>[root@server6 ~]# ls /dev/watchdog*              #查看watchdog设备文件<br>/dev<span class="hljs-built_in">/watchdog </span> /dev/watchdog0  /dev/watchdog1<br>[root@server6 ~]# wdctl /dev/watchdog1           #查看softdog设备文件信息<br>Device:        /dev/watchdog1<br>Identity:      Software<span class="hljs-built_in"> Watchdog </span>[version 0]<br>Timeout:       60 seconds<br>Pre-timeout:    0 seconds<br>FLAG           DESCRIPTION               STATUS BOOT-STATUS<br>KEEPALIVEPING  Keep alive<span class="hljs-built_in"> ping </span>reply          1           0<br>MAGICCLOSE     Supports magic close char      0           0<br>SETTIMEOUT     <span class="hljs-builtin-name">Set</span> timeout (<span class="hljs-keyword">in</span> seconds)       0           0<br>[root@server6 ~]# ehco a &gt;/dev<span class="hljs-built_in">/watchdog </span>         #追加除V以外任意字符到softdog  60秒后系统将重启<br>watchdog   watchdog0  watchdog1<br>[root@server6 ~]# echo V &gt;/dev/watchdog1         #取消测试<br></code></pre></td></tr></table></figure>
<h1 id="警告"><a href="#警告" class="headerlink" title="警告"></a>警告</h1><figure class="highlight plain"><table><tr><td class="code"><pre><code class="hljs plain">错误的watchdog配置可能导致以下情形<br>    无限重启<br>    硬重置导致文件损坏<br>    不可预测的重启<br>线上服务器慎用。<br></code></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>linuxhint.com<span class="hljs-regexp">/linux-kernel-watchdog-explained/</span><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>softdog</tag>
        <tag>watchdog</tag>
      </tags>
  </entry>
  <entry>
    <title>PostgreSQL有用的SQL</title>
    <url>/%E6%95%B0%E6%8D%AE%E5%BA%93/PostgreSQL%E6%9C%89%E7%94%A8%E7%9A%84SQL/</url>
    <content><![CDATA[<p>记录工作中常用到的PostgreSQL常用SQL， tps, qps 等等.</p>
<a id="more"></a>
<figure class="highlight n1ql"><table><tr><td class="code"><pre><code class="hljs n1ql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">schema</span> dba;<br></code></pre></td></tr></table></figure>
<h1 id="tps"><a href="#tps" class="headerlink" title="tps"></a>tps</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or replace</span> <span class="hljs-keyword">procedure</span> dba.tps() <span class="hljs-keyword">as</span> $$<br><span class="pgsql"><span class="hljs-keyword">declare</span></span><br><span class="pgsql">  v1 <span class="hljs-type">int8</span>;</span><br><span class="pgsql">  v2 <span class="hljs-type">int8</span>;</span><br><span class="pgsql"><span class="hljs-keyword">begin</span></span><br><span class="pgsql">  <span class="hljs-keyword">select</span> txid_snapshot_xmax(txid_current_snapshot()) <span class="hljs-keyword">into</span> v1;</span><br><span class="pgsql">  <span class="hljs-keyword">commit</span>;</span><br><span class="pgsql">  <span class="hljs-keyword">perform</span> pg_sleep(<span class="hljs-number">1</span>);</span><br><span class="pgsql">  <span class="hljs-keyword">select</span> txid_snapshot_xmax(txid_current_snapshot()) <span class="hljs-keyword">into</span> v2;</span><br><span class="pgsql">  <span class="hljs-keyword">commit</span>;</span><br><span class="pgsql">  <span class="hljs-keyword">raise</span> <span class="hljs-keyword">notice</span> <span class="hljs-string">&#x27;tps: %&#x27;</span>, v2-v1;</span><br><span class="pgsql"><span class="hljs-keyword">end</span>;</span><br><span class="ruby">$$</span> <span class="hljs-keyword">language</span> plpgsql ;<br></code></pre></td></tr></table></figure>
<h1 id="查询没有使用过的大于1MB的索引-top-10"><a href="#查询没有使用过的大于1MB的索引-top-10" class="headerlink" title="查询没有使用过的大于1MB的索引 top 10"></a>查询没有使用过的大于1MB的索引 top 10</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> dba.top10notusedidx <span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span><br>    pg_size_pretty(pg_relation_size(indexrelid)),<br>    *<br><span class="hljs-keyword">FROM</span><br>    pg_stat_all_indexes<br><span class="hljs-keyword">WHERE</span><br>    pg_relation_size(indexrelid) &gt;= <span class="hljs-number">1024000</span><br>    <span class="hljs-keyword">AND</span> (idx_scan = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">OR</span> idx_tup_read = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">OR</span> idx_tup_fetch = <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">AND</span> schemaname <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;pg_toast&#x27;</span>, <span class="hljs-string">&#x27;pg_catalog&#x27;</span>)<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>    pg_relation_size(indexrelid) <span class="hljs-keyword">DESC</span><br><span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure>
<p>注意, PK、UK如果只是用于约束, 可能不会被统计计数,但是不能删掉) </p>
<h1 id="查询没有使用过的大于1MB的表-top-10"><a href="#查询没有使用过的大于1MB的表-top-10" class="headerlink" title="查询没有使用过的大于1MB的表 top 10"></a>查询没有使用过的大于1MB的表 top 10</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> dba.top10notusedtab <span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span><br>    pg_size_pretty(pg_relation_size(relid)),<br>    *<br><span class="hljs-keyword">FROM</span><br>    pg_stat_all_tables<br><span class="hljs-keyword">WHERE</span><br>    pg_relation_size(relid) &gt;= <span class="hljs-number">1024000</span><br>    <span class="hljs-keyword">AND</span> seq_scan = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">AND</span> idx_scan = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">AND</span> schemaname <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;pg_toast&#x27;</span>, <span class="hljs-string">&#x27;pg_catalog&#x27;</span>, <span class="hljs-string">&#x27;information_schema&#x27;</span>)<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>    pg_relation_size(relid) <span class="hljs-keyword">DESC</span><br><span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure>
<h1 id="查询热表top-10"><a href="#查询热表top-10" class="headerlink" title="查询热表top 10"></a>查询热表top 10</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> dba.top10hottab <span class="hljs-keyword">AS</span><br><span class="hljs-keyword">SELECT</span><br>    pg_size_pretty(pg_relation_size(relid)),<br>    *<br><span class="hljs-keyword">FROM</span><br>    pg_stat_all_tables<br><span class="hljs-keyword">WHERE</span><br>    schemaname <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;pg_toast&#x27;</span>, <span class="hljs-string">&#x27;pg_catalog&#x27;</span>, <span class="hljs-string">&#x27;information_schema&#x27;</span>)<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>    seq_scan + idx_scan <span class="hljs-keyword">DESC</span>,<br>    pg_relation_size(relid) <span class="hljs-keyword">DESC</span><br><span class="hljs-keyword">LIMIT</span> <span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure>
<h1 id="在standby节点执行，-接收wal的速度。"><a href="#在standby节点执行，-接收wal的速度。" class="headerlink" title="在standby节点执行， 接收wal的速度。"></a>在standby节点执行， 接收wal的速度。</h1><figure class="highlight cal"><table><tr><td class="code"><pre><code class="hljs cal">CREATE <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-function"><span class="hljs-keyword">PROCEDURE</span> <span class="hljs-title">dba</span>.<span class="hljs-title">wal_receive_bw</span><span class="hljs-params">()</span></span><br><span class="hljs-function"> <span class="hljs-title">LANGUAGE</span> <span class="hljs-title">plpgsql</span></span><br><span class="hljs-function"><span class="hljs-title">AS</span> $<span class="hljs-title">procedure</span>$</span><br><span class="hljs-function"><span class="hljs-title">declare</span></span><br><span class="hljs-function">  <span class="hljs-title">v1</span> <span class="hljs-title">pg_lsn</span>;</span><br>  v2 pg_lsn;<br><span class="hljs-keyword">begin</span><br>  select pg_last_wal_receive_lsn() into v1;<br>  commit;<br>  perform pg_sleep(<span class="hljs-number">1</span>);<br>  select pg_last_wal_receive_lsn() into v2;<br>  commit;<br>  raise notice <span class="hljs-string">&#x27;wal receive bw: %/s&#x27;</span>, pg_size_pretty(pg_wal_lsn_diff(v2,v1));<br><span class="hljs-keyword">end</span>;<br>$<span class="hljs-function"><span class="hljs-keyword">procedure</span>$;</span><br></code></pre></td></tr></table></figure>
<h1 id="在standby节点执行，-replay-wal的速度。"><a href="#在standby节点执行，-replay-wal的速度。" class="headerlink" title="在standby节点执行， replay wal的速度。"></a>在standby节点执行， replay wal的速度。</h1><figure class="highlight cal"><table><tr><td class="code"><pre><code class="hljs cal">CREATE <span class="hljs-keyword">OR</span> REPLACE <span class="hljs-function"><span class="hljs-keyword">PROCEDURE</span> <span class="hljs-title">dba</span>.<span class="hljs-title">wal_replay_bw</span><span class="hljs-params">()</span></span><br><span class="hljs-function"> <span class="hljs-title">LANGUAGE</span> <span class="hljs-title">plpgsql</span></span><br><span class="hljs-function"><span class="hljs-title">AS</span> $<span class="hljs-title">procedure</span>$</span><br><span class="hljs-function"><span class="hljs-title">declare</span></span><br><span class="hljs-function">  <span class="hljs-title">v1</span> <span class="hljs-title">pg_lsn</span>;</span><br>  v2 pg_lsn;<br><span class="hljs-keyword">begin</span><br>  select pg_last_wal_replay_lsn() into v1;<br>  commit;<br>  perform pg_sleep(<span class="hljs-number">1</span>);<br>  select pg_last_wal_replay_lsn() into v2;<br>  commit;<br>  raise notice <span class="hljs-string">&#x27;wal replay bw: %/s&#x27;</span>, pg_size_pretty(pg_wal_lsn_diff(v2,v1));<br><span class="hljs-keyword">end</span>;<br>$<span class="hljs-function"><span class="hljs-keyword">procedure</span>$;</span> <br></code></pre></td></tr></table></figure>
<h1 id="查询膨胀空间top-10的表"><a href="#查询膨胀空间top-10的表" class="headerlink" title="查询膨胀空间top 10的表"></a>查询膨胀空间top 10的表</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.top10bloatsizetable <span class="hljs-keyword">as</span>  <br><span class="hljs-keyword">SELECT</span>  <br>  current_database() <span class="hljs-keyword">AS</span> db, schemaname, tablename, reltuples::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> tups, relpages::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> pages, otta,  <br>  ROUND(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> otta=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> sml.relpages=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> sml.relpages=otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0.0</span> <span class="hljs-keyword">ELSE</span> sml.relpages/otta::<span class="hljs-type">numeric</span> <span class="hljs-keyword">END</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> tbloat,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> relpages::<span class="hljs-type">bigint</span> - otta <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedpages,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(sml.relpages-otta)::<span class="hljs-type">bigint</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedbytes,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;0 bytes&#x27;</span>::<span class="hljs-type">text</span> <span class="hljs-keyword">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedsize,  <br>  iname, ituples::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> itups, ipages::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> ipages, iotta,  <br>  ROUND(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> iotta=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> ipages=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> ipages=iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0.0</span> <span class="hljs-keyword">ELSE</span> ipages/iotta::<span class="hljs-type">numeric</span> <span class="hljs-keyword">END</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> ibloat,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> ipages::<span class="hljs-type">bigint</span> - iotta <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedipages,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(ipages-iotta) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedibytes,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;0 bytes&#x27;</span> <span class="hljs-keyword">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedisize,  <br>  pg_size_pretty(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span>  <br>    <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(ipages-iotta::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span>  <br>    <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> bs*(relpages-otta::<span class="hljs-type">bigint</span>)  <br>      <span class="hljs-keyword">ELSE</span> bs*(relpages-otta::<span class="hljs-type">bigint</span> + ipages-iotta::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span>  <br>  <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> totalwastedbytes  <br><span class="hljs-keyword">FROM</span> (  <br>  <span class="hljs-keyword">SELECT</span>  <br>    nn.nspname <span class="hljs-keyword">AS</span> schemaname,  <br>    cc.relname <span class="hljs-keyword">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> relpages,  <br>    COALESCE(bs,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> datahdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> datahdr%ma <span class="hljs-keyword">END</span>))+nullhdr2+<span class="hljs-number">4</span>))/(bs<span class="hljs-number">-20</span>::<span class="hljs-type">float</span>)),<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> otta,  <br>    COALESCE(c2.relname,<span class="hljs-string">&#x27;?&#x27;</span>) <span class="hljs-keyword">AS</span> iname, COALESCE(c2.reltuples,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> ituples, COALESCE(c2.relpages,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class="hljs-number">-12</span>))/(bs<span class="hljs-number">-20</span>::<span class="hljs-type">float</span>)),<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> iotta <span class="hljs-comment">-- very rough approximation, assumes all cols  </span><br>  <span class="hljs-keyword">FROM</span>  <br>     pg_class cc  <br>  <span class="hljs-keyword">JOIN</span> pg_namespace nn <span class="hljs-keyword">ON</span> cc.relnamespace = nn.oid <span class="hljs-keyword">AND</span> nn.nspname &lt;&gt; <span class="hljs-string">&#x27;information_schema&#x27;</span>  <br>  <span class="hljs-keyword">LEFT JOIN</span>  <br>  (  <br>    <span class="hljs-keyword">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> hdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> hdr%ma <span class="hljs-keyword">END</span>)))::<span class="hljs-type">numeric</span> <span class="hljs-keyword">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> nullhdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> nullhdr%ma <span class="hljs-keyword">END</span>))) <span class="hljs-keyword">AS</span> nullhdr2  <br>    <span class="hljs-keyword">FROM</span> (  <br>      <span class="hljs-keyword">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class="hljs-number">1</span>-coalesce(null_frac,<span class="hljs-number">0</span>))*coalesce(avg_width, <span class="hljs-number">2048</span>)) <span class="hljs-keyword">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class="hljs-number">0</span>)) <span class="hljs-keyword">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>+count(*)/<span class="hljs-number">8</span>  <br>          <span class="hljs-keyword">FROM</span> pg_stats s2  <br>          <span class="hljs-keyword">WHERE</span> null_frac&lt;&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> s2.schemaname = ns.nspname <span class="hljs-keyword">AND</span> s2.tablename = tbl.relname  <br>        ) <span class="hljs-keyword">AS</span> nullhdr  <br>      <span class="hljs-keyword">FROM</span> pg_attribute att  <br>      <span class="hljs-keyword">JOIN</span> pg_class tbl <span class="hljs-keyword">ON</span> att.attrelid = tbl.oid  <br>      <span class="hljs-keyword">JOIN</span> pg_namespace ns <span class="hljs-keyword">ON</span> ns.oid = tbl.relnamespace  <br>      <span class="hljs-keyword">LEFT JOIN</span> pg_stats s <span class="hljs-keyword">ON</span> s.schemaname=ns.nspname  <br>      <span class="hljs-keyword">AND</span> s.tablename = tbl.relname  <br>      <span class="hljs-keyword">AND</span> s.inherited=<span class="hljs-keyword">false</span>  <br>      <span class="hljs-keyword">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class="hljs-keyword">SELECT</span>  <br>          (<span class="hljs-keyword">SELECT</span> current_setting(<span class="hljs-string">&#x27;block_size&#x27;</span>)::<span class="hljs-type">numeric</span>) <span class="hljs-keyword">AS</span> bs,  <br>            <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">FROM</span> <span class="hljs-string">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;#&#x27;</span>)  <br>              <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;8.0&#x27;</span>,<span class="hljs-string">&#x27;8.1&#x27;</span>,<span class="hljs-string">&#x27;8.2&#x27;</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">27</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">23</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> hdr,  <br>          <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> v ~ <span class="hljs-string">&#x27;mingw32&#x27;</span> <span class="hljs-keyword">OR</span> v ~ <span class="hljs-string">&#x27;64-bit&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">8</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">4</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> ma  <br>        <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> version() <span class="hljs-keyword">AS</span> v) <span class="hljs-keyword">AS</span> foo  <br>      ) <span class="hljs-keyword">AS</span> constants  <br>      <span class="hljs-keyword">WHERE</span> att.attnum &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> tbl.relkind=<span class="hljs-string">&#x27;r&#x27;</span>  <br>      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>  <br>    ) <span class="hljs-keyword">AS</span> foo  <br>  ) <span class="hljs-keyword">AS</span> rs  <br>  <span class="hljs-keyword">ON</span> cc.relname = rs.relname <span class="hljs-keyword">AND</span> nn.nspname = rs.nspname  <br>  <span class="hljs-keyword">LEFT JOIN</span> pg_index i <span class="hljs-keyword">ON</span> indrelid = cc.oid  <br>  <span class="hljs-keyword">LEFT JOIN</span> pg_class c2 <span class="hljs-keyword">ON</span> c2.oid = i.indexrelid  <br>) <span class="hljs-keyword">AS</span> sml <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> wastedbytes <span class="hljs-keyword">desc</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">5</span>;  <br></code></pre></td></tr></table></figure>
<h1 id="查询膨胀空间top-10的索引"><a href="#查询膨胀空间top-10的索引" class="headerlink" title="查询膨胀空间top 10的索引"></a>查询膨胀空间top 10的索引</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.top10bloatsizeindex <span class="hljs-keyword">as</span>  <br><span class="hljs-keyword">SELECT</span>  <br>  current_database() <span class="hljs-keyword">AS</span> db, schemaname, tablename, reltuples::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> tups, relpages::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> pages, otta,  <br>  ROUND(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> otta=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> sml.relpages=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> sml.relpages=otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0.0</span> <span class="hljs-keyword">ELSE</span> sml.relpages/otta::<span class="hljs-type">numeric</span> <span class="hljs-keyword">END</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> tbloat,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> relpages::<span class="hljs-type">bigint</span> - otta <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedpages,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(sml.relpages-otta)::<span class="hljs-type">bigint</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedbytes,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;0 bytes&#x27;</span>::<span class="hljs-type">text</span> <span class="hljs-keyword">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedsize,  <br>  iname, ituples::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> itups, ipages::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> ipages, iotta,  <br>  ROUND(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> iotta=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> ipages=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> ipages=iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0.0</span> <span class="hljs-keyword">ELSE</span> ipages/iotta::<span class="hljs-type">numeric</span> <span class="hljs-keyword">END</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> ibloat,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> ipages::<span class="hljs-type">bigint</span> - iotta <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedipages,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(ipages-iotta) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedibytes,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;0 bytes&#x27;</span> <span class="hljs-keyword">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedisize,  <br>  pg_size_pretty(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span>  <br>    <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(ipages-iotta::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span>  <br>    <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> bs*(relpages-otta::<span class="hljs-type">bigint</span>)  <br>      <span class="hljs-keyword">ELSE</span> bs*(relpages-otta::<span class="hljs-type">bigint</span> + ipages-iotta::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span>  <br>  <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> totalwastedbytes  <br><span class="hljs-keyword">FROM</span> (  <br>  <span class="hljs-keyword">SELECT</span>  <br>    nn.nspname <span class="hljs-keyword">AS</span> schemaname,  <br>    cc.relname <span class="hljs-keyword">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> relpages,  <br>    COALESCE(bs,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> datahdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> datahdr%ma <span class="hljs-keyword">END</span>))+nullhdr2+<span class="hljs-number">4</span>))/(bs<span class="hljs-number">-20</span>::<span class="hljs-type">float</span>)),<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> otta,  <br>    COALESCE(c2.relname,<span class="hljs-string">&#x27;?&#x27;</span>) <span class="hljs-keyword">AS</span> iname, COALESCE(c2.reltuples,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> ituples, COALESCE(c2.relpages,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class="hljs-number">-12</span>))/(bs<span class="hljs-number">-20</span>::<span class="hljs-type">float</span>)),<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> iotta <span class="hljs-comment">-- very rough approximation, assumes all cols  </span><br>  <span class="hljs-keyword">FROM</span>  <br>     pg_class cc  <br>  <span class="hljs-keyword">JOIN</span> pg_namespace nn <span class="hljs-keyword">ON</span> cc.relnamespace = nn.oid <span class="hljs-keyword">AND</span> nn.nspname &lt;&gt; <span class="hljs-string">&#x27;information_schema&#x27;</span>  <br>  <span class="hljs-keyword">LEFT JOIN</span>  <br>  (  <br>    <span class="hljs-keyword">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> hdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> hdr%ma <span class="hljs-keyword">END</span>)))::<span class="hljs-type">numeric</span> <span class="hljs-keyword">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> nullhdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> nullhdr%ma <span class="hljs-keyword">END</span>))) <span class="hljs-keyword">AS</span> nullhdr2  <br>    <span class="hljs-keyword">FROM</span> (  <br>      <span class="hljs-keyword">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class="hljs-number">1</span>-coalesce(null_frac,<span class="hljs-number">0</span>))*coalesce(avg_width, <span class="hljs-number">2048</span>)) <span class="hljs-keyword">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class="hljs-number">0</span>)) <span class="hljs-keyword">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>+count(*)/<span class="hljs-number">8</span>  <br>          <span class="hljs-keyword">FROM</span> pg_stats s2  <br>          <span class="hljs-keyword">WHERE</span> null_frac&lt;&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> s2.schemaname = ns.nspname <span class="hljs-keyword">AND</span> s2.tablename = tbl.relname  <br>        ) <span class="hljs-keyword">AS</span> nullhdr  <br>      <span class="hljs-keyword">FROM</span> pg_attribute att  <br>      <span class="hljs-keyword">JOIN</span> pg_class tbl <span class="hljs-keyword">ON</span> att.attrelid = tbl.oid  <br>      <span class="hljs-keyword">JOIN</span> pg_namespace ns <span class="hljs-keyword">ON</span> ns.oid = tbl.relnamespace  <br>      <span class="hljs-keyword">LEFT JOIN</span> pg_stats s <span class="hljs-keyword">ON</span> s.schemaname=ns.nspname  <br>      <span class="hljs-keyword">AND</span> s.tablename = tbl.relname  <br>      <span class="hljs-keyword">AND</span> s.inherited=<span class="hljs-keyword">false</span>  <br>      <span class="hljs-keyword">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class="hljs-keyword">SELECT</span>  <br>          (<span class="hljs-keyword">SELECT</span> current_setting(<span class="hljs-string">&#x27;block_size&#x27;</span>)::<span class="hljs-type">numeric</span>) <span class="hljs-keyword">AS</span> bs,  <br>            <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">FROM</span> <span class="hljs-string">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;#&#x27;</span>)  <br>              <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;8.0&#x27;</span>,<span class="hljs-string">&#x27;8.1&#x27;</span>,<span class="hljs-string">&#x27;8.2&#x27;</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">27</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">23</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> hdr,  <br>          <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> v ~ <span class="hljs-string">&#x27;mingw32&#x27;</span> <span class="hljs-keyword">OR</span> v ~ <span class="hljs-string">&#x27;64-bit&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">8</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">4</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> ma  <br>        <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> version() <span class="hljs-keyword">AS</span> v) <span class="hljs-keyword">AS</span> foo  <br>      ) <span class="hljs-keyword">AS</span> constants  <br>      <span class="hljs-keyword">WHERE</span> att.attnum &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> tbl.relkind=<span class="hljs-string">&#x27;r&#x27;</span>  <br>      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>  <br>    ) <span class="hljs-keyword">AS</span> foo  <br>  ) <span class="hljs-keyword">AS</span> rs  <br>  <span class="hljs-keyword">ON</span> cc.relname = rs.relname <span class="hljs-keyword">AND</span> nn.nspname = rs.nspname  <br>  <span class="hljs-keyword">LEFT JOIN</span> pg_index i <span class="hljs-keyword">ON</span> indrelid = cc.oid  <br>  <span class="hljs-keyword">LEFT JOIN</span> pg_class c2 <span class="hljs-keyword">ON</span> c2.oid = i.indexrelid  <br>) <span class="hljs-keyword">AS</span> sml <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> wastedibytes <span class="hljs-keyword">desc</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">5</span>;  <br></code></pre></td></tr></table></figure>
<h1 id="查询膨胀比例top-10的表-浪费空间大于10MB的表"><a href="#查询膨胀比例top-10的表-浪费空间大于10MB的表" class="headerlink" title="查询膨胀比例top 10的表(浪费空间大于10MB的表)"></a>查询膨胀比例top 10的表(浪费空间大于10MB的表)</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.top10bloatratiotable <span class="hljs-keyword">as</span>  <br><span class="hljs-keyword">SELECT</span>  <br>  current_database() <span class="hljs-keyword">AS</span> db, schemaname, tablename, reltuples::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> tups, relpages::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> pages, otta,  <br>  ROUND(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> otta=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> sml.relpages=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> sml.relpages=otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0.0</span> <span class="hljs-keyword">ELSE</span> sml.relpages/otta::<span class="hljs-type">numeric</span> <span class="hljs-keyword">END</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> tbloat,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> relpages::<span class="hljs-type">bigint</span> - otta <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedpages,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(sml.relpages-otta)::<span class="hljs-type">bigint</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedbytes,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;0 bytes&#x27;</span>::<span class="hljs-type">text</span> <span class="hljs-keyword">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedsize,  <br>  iname, ituples::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> itups, ipages::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> ipages, iotta,  <br>  ROUND(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> iotta=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> ipages=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> ipages=iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0.0</span> <span class="hljs-keyword">ELSE</span> ipages/iotta::<span class="hljs-type">numeric</span> <span class="hljs-keyword">END</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> ibloat,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> ipages::<span class="hljs-type">bigint</span> - iotta <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedipages,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(ipages-iotta) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedibytes,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;0 bytes&#x27;</span> <span class="hljs-keyword">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedisize,  <br>  pg_size_pretty(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span>  <br>    <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(ipages-iotta::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span>  <br>    <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> bs*(relpages-otta::<span class="hljs-type">bigint</span>)  <br>      <span class="hljs-keyword">ELSE</span> bs*(relpages-otta::<span class="hljs-type">bigint</span> + ipages-iotta::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span>  <br>  <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> totalwastedbytes  <br><span class="hljs-keyword">FROM</span> (  <br>  <span class="hljs-keyword">SELECT</span>  <br>    nn.nspname <span class="hljs-keyword">AS</span> schemaname,  <br>    cc.relname <span class="hljs-keyword">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> relpages,  <br>    COALESCE(bs,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> datahdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> datahdr%ma <span class="hljs-keyword">END</span>))+nullhdr2+<span class="hljs-number">4</span>))/(bs<span class="hljs-number">-20</span>::<span class="hljs-type">float</span>)),<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> otta,  <br>    COALESCE(c2.relname,<span class="hljs-string">&#x27;?&#x27;</span>) <span class="hljs-keyword">AS</span> iname, COALESCE(c2.reltuples,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> ituples, COALESCE(c2.relpages,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class="hljs-number">-12</span>))/(bs<span class="hljs-number">-20</span>::<span class="hljs-type">float</span>)),<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> iotta <span class="hljs-comment">-- very rough approximation, assumes all cols  </span><br>  <span class="hljs-keyword">FROM</span>  <br>     pg_class cc  <br>  <span class="hljs-keyword">JOIN</span> pg_namespace nn <span class="hljs-keyword">ON</span> cc.relnamespace = nn.oid <span class="hljs-keyword">AND</span> nn.nspname &lt;&gt; <span class="hljs-string">&#x27;information_schema&#x27;</span>  <br>  <span class="hljs-keyword">LEFT JOIN</span>  <br>  (  <br>    <span class="hljs-keyword">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> hdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> hdr%ma <span class="hljs-keyword">END</span>)))::<span class="hljs-type">numeric</span> <span class="hljs-keyword">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> nullhdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> nullhdr%ma <span class="hljs-keyword">END</span>))) <span class="hljs-keyword">AS</span> nullhdr2  <br>    <span class="hljs-keyword">FROM</span> (  <br>      <span class="hljs-keyword">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class="hljs-number">1</span>-coalesce(null_frac,<span class="hljs-number">0</span>))*coalesce(avg_width, <span class="hljs-number">2048</span>)) <span class="hljs-keyword">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class="hljs-number">0</span>)) <span class="hljs-keyword">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>+count(*)/<span class="hljs-number">8</span>  <br>          <span class="hljs-keyword">FROM</span> pg_stats s2  <br>          <span class="hljs-keyword">WHERE</span> null_frac&lt;&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> s2.schemaname = ns.nspname <span class="hljs-keyword">AND</span> s2.tablename = tbl.relname  <br>        ) <span class="hljs-keyword">AS</span> nullhdr  <br>      <span class="hljs-keyword">FROM</span> pg_attribute att  <br>      <span class="hljs-keyword">JOIN</span> pg_class tbl <span class="hljs-keyword">ON</span> att.attrelid = tbl.oid  <br>      <span class="hljs-keyword">JOIN</span> pg_namespace ns <span class="hljs-keyword">ON</span> ns.oid = tbl.relnamespace  <br>      <span class="hljs-keyword">LEFT JOIN</span> pg_stats s <span class="hljs-keyword">ON</span> s.schemaname=ns.nspname  <br>      <span class="hljs-keyword">AND</span> s.tablename = tbl.relname  <br>      <span class="hljs-keyword">AND</span> s.inherited=<span class="hljs-keyword">false</span>  <br>      <span class="hljs-keyword">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class="hljs-keyword">SELECT</span>  <br>          (<span class="hljs-keyword">SELECT</span> current_setting(<span class="hljs-string">&#x27;block_size&#x27;</span>)::<span class="hljs-type">numeric</span>) <span class="hljs-keyword">AS</span> bs,  <br>            <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">FROM</span> <span class="hljs-string">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;#&#x27;</span>)  <br>              <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;8.0&#x27;</span>,<span class="hljs-string">&#x27;8.1&#x27;</span>,<span class="hljs-string">&#x27;8.2&#x27;</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">27</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">23</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> hdr,  <br>          <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> v ~ <span class="hljs-string">&#x27;mingw32&#x27;</span> <span class="hljs-keyword">OR</span> v ~ <span class="hljs-string">&#x27;64-bit&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">8</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">4</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> ma  <br>        <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> version() <span class="hljs-keyword">AS</span> v) <span class="hljs-keyword">AS</span> foo  <br>      ) <span class="hljs-keyword">AS</span> constants  <br>      <span class="hljs-keyword">WHERE</span> att.attnum &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> tbl.relkind=<span class="hljs-string">&#x27;r&#x27;</span>  <br>      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>  <br>    ) <span class="hljs-keyword">AS</span> foo  <br>  ) <span class="hljs-keyword">AS</span> rs  <br>  <span class="hljs-keyword">ON</span> cc.relname = rs.relname <span class="hljs-keyword">AND</span> nn.nspname = rs.nspname  <br>  <span class="hljs-keyword">LEFT JOIN</span> pg_index i <span class="hljs-keyword">ON</span> indrelid = cc.oid  <br>  <span class="hljs-keyword">LEFT JOIN</span> pg_class c2 <span class="hljs-keyword">ON</span> c2.oid = i.indexrelid  <br>) <span class="hljs-keyword">AS</span> sml   <br><span class="hljs-keyword">where</span> (<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(sml.relpages-otta)::<span class="hljs-type">bigint</span> <span class="hljs-keyword">END</span>) &gt;= <span class="hljs-number">10240000</span>  <br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> tbloat <span class="hljs-keyword">desc</span>,wastedbytes <span class="hljs-keyword">desc</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">5</span>;  <br></code></pre></td></tr></table></figure>
<h1 id="查询膨胀比例top-10的索引-浪费空间大于10MB的索引"><a href="#查询膨胀比例top-10的索引-浪费空间大于10MB的索引" class="headerlink" title="查询膨胀比例top 10的索引(浪费空间大于10MB的索引)"></a>查询膨胀比例top 10的索引(浪费空间大于10MB的索引)</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.top10bloatratioindex <span class="hljs-keyword">as</span>  <br><span class="hljs-keyword">SELECT</span>  <br>  current_database() <span class="hljs-keyword">AS</span> db, schemaname, tablename, reltuples::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> tups, relpages::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> pages, otta,  <br>  ROUND(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> otta=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> sml.relpages=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> sml.relpages=otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0.0</span> <span class="hljs-keyword">ELSE</span> sml.relpages/otta::<span class="hljs-type">numeric</span> <span class="hljs-keyword">END</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> tbloat,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> relpages::<span class="hljs-type">bigint</span> - otta <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedpages,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(sml.relpages-otta)::<span class="hljs-type">bigint</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedbytes,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;0 bytes&#x27;</span>::<span class="hljs-type">text</span> <span class="hljs-keyword">ELSE</span> pg_size_pretty((bs*(relpages-otta))::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedsize,  <br>  iname, ituples::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> itups, ipages::<span class="hljs-type">bigint</span> <span class="hljs-keyword">AS</span> ipages, iotta,  <br>  ROUND(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> iotta=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> ipages=<span class="hljs-number">0</span> <span class="hljs-keyword">OR</span> ipages=iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0.0</span> <span class="hljs-keyword">ELSE</span> ipages/iotta::<span class="hljs-type">numeric</span> <span class="hljs-keyword">END</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">AS</span> ibloat,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> ipages::<span class="hljs-type">bigint</span> - iotta <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedipages,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(ipages-iotta) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedibytes,  <br>  <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-string">&#x27;0 bytes&#x27;</span> <span class="hljs-keyword">ELSE</span> pg_size_pretty((bs*(ipages-iotta))::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> wastedisize,  <br>  pg_size_pretty(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> relpages &lt; otta <span class="hljs-keyword">THEN</span>  <br>    <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(ipages-iotta::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span>  <br>    <span class="hljs-keyword">ELSE</span> <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> bs*(relpages-otta::<span class="hljs-type">bigint</span>)  <br>      <span class="hljs-keyword">ELSE</span> bs*(relpages-otta::<span class="hljs-type">bigint</span> + ipages-iotta::<span class="hljs-type">bigint</span>) <span class="hljs-keyword">END</span>  <br>  <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> totalwastedbytes  <br><span class="hljs-keyword">FROM</span> (  <br>  <span class="hljs-keyword">SELECT</span>  <br>    nn.nspname <span class="hljs-keyword">AS</span> schemaname,  <br>    cc.relname <span class="hljs-keyword">AS</span> tablename,  <br>    COALESCE(cc.reltuples,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> reltuples,  <br>    COALESCE(cc.relpages,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> relpages,  <br>    COALESCE(bs,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> bs,  <br>    COALESCE(CEIL((cc.reltuples*((datahdr+ma-  <br>      (<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> datahdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> datahdr%ma <span class="hljs-keyword">END</span>))+nullhdr2+<span class="hljs-number">4</span>))/(bs<span class="hljs-number">-20</span>::<span class="hljs-type">float</span>)),<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> otta,  <br>    COALESCE(c2.relname,<span class="hljs-string">&#x27;?&#x27;</span>) <span class="hljs-keyword">AS</span> iname, COALESCE(c2.reltuples,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> ituples, COALESCE(c2.relpages,<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> ipages,  <br>    COALESCE(CEIL((c2.reltuples*(datahdr<span class="hljs-number">-12</span>))/(bs<span class="hljs-number">-20</span>::<span class="hljs-type">float</span>)),<span class="hljs-number">0</span>) <span class="hljs-keyword">AS</span> iotta <span class="hljs-comment">-- very rough approximation, assumes all cols  </span><br>  <span class="hljs-keyword">FROM</span>  <br>     pg_class cc  <br>  <span class="hljs-keyword">JOIN</span> pg_namespace nn <span class="hljs-keyword">ON</span> cc.relnamespace = nn.oid <span class="hljs-keyword">AND</span> nn.nspname &lt;&gt; <span class="hljs-string">&#x27;information_schema&#x27;</span>  <br>  <span class="hljs-keyword">LEFT JOIN</span>  <br>  (  <br>    <span class="hljs-keyword">SELECT</span>  <br>      ma,bs,foo.nspname,foo.relname,  <br>      (datawidth+(hdr+ma-(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> hdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> hdr%ma <span class="hljs-keyword">END</span>)))::<span class="hljs-type">numeric</span> <span class="hljs-keyword">AS</span> datahdr,  <br>      (maxfracsum*(nullhdr+ma-(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> nullhdr%ma=<span class="hljs-number">0</span> <span class="hljs-keyword">THEN</span> ma <span class="hljs-keyword">ELSE</span> nullhdr%ma <span class="hljs-keyword">END</span>))) <span class="hljs-keyword">AS</span> nullhdr2  <br>    <span class="hljs-keyword">FROM</span> (  <br>      <span class="hljs-keyword">SELECT</span>  <br>        ns.nspname, tbl.relname, hdr, ma, bs,  <br>        SUM((<span class="hljs-number">1</span>-coalesce(null_frac,<span class="hljs-number">0</span>))*coalesce(avg_width, <span class="hljs-number">2048</span>)) <span class="hljs-keyword">AS</span> datawidth,  <br>        MAX(coalesce(null_frac,<span class="hljs-number">0</span>)) <span class="hljs-keyword">AS</span> maxfracsum,  <br>        hdr+(  <br>          <span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span>+count(*)/<span class="hljs-number">8</span>  <br>          <span class="hljs-keyword">FROM</span> pg_stats s2  <br>          <span class="hljs-keyword">WHERE</span> null_frac&lt;&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> s2.schemaname = ns.nspname <span class="hljs-keyword">AND</span> s2.tablename = tbl.relname  <br>        ) <span class="hljs-keyword">AS</span> nullhdr  <br>      <span class="hljs-keyword">FROM</span> pg_attribute att  <br>      <span class="hljs-keyword">JOIN</span> pg_class tbl <span class="hljs-keyword">ON</span> att.attrelid = tbl.oid  <br>      <span class="hljs-keyword">JOIN</span> pg_namespace ns <span class="hljs-keyword">ON</span> ns.oid = tbl.relnamespace  <br>      <span class="hljs-keyword">LEFT JOIN</span> pg_stats s <span class="hljs-keyword">ON</span> s.schemaname=ns.nspname  <br>      <span class="hljs-keyword">AND</span> s.tablename = tbl.relname  <br>      <span class="hljs-keyword">AND</span> s.inherited=<span class="hljs-keyword">false</span>  <br>      <span class="hljs-keyword">AND</span> s.attname=att.attname,  <br>      (  <br>        <span class="hljs-keyword">SELECT</span>  <br>          (<span class="hljs-keyword">SELECT</span> current_setting(<span class="hljs-string">&#x27;block_size&#x27;</span>)::<span class="hljs-type">numeric</span>) <span class="hljs-keyword">AS</span> bs,  <br>            <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> SUBSTRING(SPLIT_PART(v, <span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">FROM</span> <span class="hljs-string">&#x27;#&quot;[0-9]+.[0-9]+#&quot;%&#x27;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&#x27;#&#x27;</span>)  <br>              <span class="hljs-keyword">IN</span> (<span class="hljs-string">&#x27;8.0&#x27;</span>,<span class="hljs-string">&#x27;8.1&#x27;</span>,<span class="hljs-string">&#x27;8.2&#x27;</span>) <span class="hljs-keyword">THEN</span> <span class="hljs-number">27</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">23</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> hdr,  <br>          <span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> v ~ <span class="hljs-string">&#x27;mingw32&#x27;</span> <span class="hljs-keyword">OR</span> v ~ <span class="hljs-string">&#x27;64-bit&#x27;</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">8</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">4</span> <span class="hljs-keyword">END</span> <span class="hljs-keyword">AS</span> ma  <br>        <span class="hljs-keyword">FROM</span> (<span class="hljs-keyword">SELECT</span> version() <span class="hljs-keyword">AS</span> v) <span class="hljs-keyword">AS</span> foo  <br>      ) <span class="hljs-keyword">AS</span> constants  <br>      <span class="hljs-keyword">WHERE</span> att.attnum &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">AND</span> tbl.relkind=<span class="hljs-string">&#x27;r&#x27;</span>  <br>      <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>  <br>    ) <span class="hljs-keyword">AS</span> foo  <br>  ) <span class="hljs-keyword">AS</span> rs  <br>  <span class="hljs-keyword">ON</span> cc.relname = rs.relname <span class="hljs-keyword">AND</span> nn.nspname = rs.nspname  <br>  <span class="hljs-keyword">LEFT JOIN</span> pg_index i <span class="hljs-keyword">ON</span> indrelid = cc.oid  <br>  <span class="hljs-keyword">LEFT JOIN</span> pg_class c2 <span class="hljs-keyword">ON</span> c2.oid = i.indexrelid  <br>) <span class="hljs-keyword">AS</span> sml   <br><span class="hljs-keyword">where</span> (<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> ipages &lt; iotta <span class="hljs-keyword">THEN</span> <span class="hljs-number">0</span> <span class="hljs-keyword">ELSE</span> bs*(ipages-iotta) <span class="hljs-keyword">END</span>) &gt;= <span class="hljs-number">10240000</span>  <br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> ibloat <span class="hljs-keyword">desc</span>,wastedibytes <span class="hljs-keyword">desc</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">5</span>; <br></code></pre></td></tr></table></figure>
<h1 id="查询序列距离最大值的范围"><a href="#查询序列距离最大值的范围" class="headerlink" title="查询序列距离最大值的范围"></a>查询序列距离最大值的范围</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.seqs <span class="hljs-keyword">as</span> <span class="hljs-keyword">select</span> max_value-last_value,* <span class="hljs-keyword">from</span> pg_sequences <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> max_value-last_value ;<br></code></pre></td></tr></table></figure>
<h1 id="freeze风暴预测相关的3个视图"><a href="#freeze风暴预测相关的3个视图" class="headerlink" title="freeze风暴预测相关的3个视图"></a>freeze风暴预测相关的3个视图</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.v_freeze <span class="hljs-keyword">as</span>    <br><span class="hljs-keyword">select</span>     <br>  e.*,     <br>  a.*     <br><span class="hljs-keyword">from</span>    <br>(<span class="hljs-keyword">select</span>     <br>  current_setting(<span class="hljs-string">&#x27;autovacuum_freeze_max_age&#x27;</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">as</span> v1,            <span class="hljs-comment">-- 如果表的事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    </span><br>  current_setting(<span class="hljs-string">&#x27;autovacuum_multixact_freeze_max_age&#x27;</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">as</span> v2,  <span class="hljs-comment">-- 如果表的并行事务ID年龄大于该值, 即使未开启autovacuum也会强制触发FREEZE, 并告警Preventing Transaction ID Wraparound Failures    </span><br>  current_setting(<span class="hljs-string">&#x27;vacuum_freeze_min_age&#x27;</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">as</span> v3,                <span class="hljs-comment">-- 手动或自动垃圾回收时, 如果记录的事务ID年龄大于该值, 将被FREEZE    </span><br>  current_setting(<span class="hljs-string">&#x27;vacuum_multixact_freeze_min_age&#x27;</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">as</span> v4,      <span class="hljs-comment">-- 手动或自动垃圾回收时, 如果记录的并行事务ID年龄大于该值, 将被FREEZE    </span><br>  current_setting(<span class="hljs-string">&#x27;vacuum_freeze_table_age&#x27;</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">as</span> v5,              <span class="hljs-comment">-- 手动垃圾回收时, 如果表的事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_freeze_max_age    </span><br>  current_setting(<span class="hljs-string">&#x27;vacuum_multixact_freeze_table_age&#x27;</span>)::<span class="hljs-type">int</span> <span class="hljs-keyword">as</span> v6,    <span class="hljs-comment">-- 手动垃圾回收时, 如果表的并行事务ID年龄大于该值, 将触发FREEZE. 该参数的上限值为 %95 autovacuum_multixact_freeze_max_age    </span><br>  current_setting(<span class="hljs-string">&#x27;autovacuum_vacuum_cost_delay&#x27;</span>) <span class="hljs-keyword">as</span> v7,              <span class="hljs-comment">-- 自动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源. -1 表示沿用vacuum_cost_delay的设置    </span><br>  current_setting(<span class="hljs-string">&#x27;autovacuum_vacuum_cost_limit&#x27;</span>) <span class="hljs-keyword">as</span> v8,              <span class="hljs-comment">-- 自动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定. -1 表示沿用vacuum_cost_limit的设置    </span><br>  current_setting(<span class="hljs-string">&#x27;vacuum_cost_delay&#x27;</span>) <span class="hljs-keyword">as</span> v9,                         <span class="hljs-comment">-- 手动垃圾回收时, 每轮回收周期后的一个休息时间, 主要防止垃圾回收太耗资源.    </span><br>  current_setting(<span class="hljs-string">&#x27;vacuum_cost_limit&#x27;</span>) <span class="hljs-keyword">as</span> v10,                        <span class="hljs-comment">-- 手动垃圾回收时, 每轮回收周期设多大限制, 限制由vacuum_cost_page_hit,vacuum_cost_page_missvacuum_cost_page_dirty参数以及周期内的操作决定.    </span><br>  current_setting(<span class="hljs-string">&#x27;autovacuum&#x27;</span>) <span class="hljs-keyword">as</span> autovacuum                         <span class="hljs-comment">-- 是否开启自动垃圾回收    </span><br>) a,     <br><span class="hljs-keyword">LATERAL</span> (   <span class="hljs-comment">-- LATERAL 允许你在这个SUBQUERY中直接引用前面的table, subquery中的column     </span><br><span class="hljs-keyword">select</span>     <br>pg_size_pretty(pg_total_relation_size(<span class="hljs-type">oid</span>)) sz,   <span class="hljs-comment">-- 表的大小(含TOAST, 索引)    </span><br><span class="hljs-type">oid</span>::<span class="hljs-type">regclass</span> <span class="hljs-keyword">as</span> reloid,    <span class="hljs-comment">-- 表名(物化视图)    </span><br>relkind,                    <span class="hljs-comment">-- r=表, m=物化视图    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class="hljs-type">text</span>, <span class="hljs-string">&#x27;autovacuum_freeze_max_age=(\d+)&#x27;</span>)::<span class="hljs-type">int</span>,     <br>    substring(reloptions::<span class="hljs-type">text</span>, <span class="hljs-string">&#x27;autovacuum_freeze_table_age=(\d+)&#x27;</span>)::<span class="hljs-type">int</span>     <br>  ),    <br>  a.v1    <br>)    <br>-    <br>age(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> relfrozenxid::<span class="hljs-type">text</span>::<span class="hljs-type">int</span>&lt;<span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">else</span> relfrozenxid <span class="hljs-keyword">end</span>)     <br><span class="hljs-keyword">as</span> remain_ages_xid,   <span class="hljs-comment">-- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class="hljs-type">text</span>, <span class="hljs-string">&#x27;autovacuum_multixact_freeze_max_age=(\d+)&#x27;</span>)::<span class="hljs-type">int</span>,     <br>    substring(reloptions::<span class="hljs-type">text</span>, <span class="hljs-string">&#x27;autovacuum_multixact_freeze_table_age=(\d+)&#x27;</span>)::<span class="hljs-type">int</span>     <br>  ),    <br>  a.v2    <br>)    <br>-    <br>age(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> relminmxid::<span class="hljs-type">text</span>::<span class="hljs-type">int</span>&lt;<span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">else</span> relminmxid <span class="hljs-keyword">end</span>)     <br><span class="hljs-keyword">as</span> remain_ages_mxid,  <span class="hljs-comment">-- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为并发事务ID    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class="hljs-type">text</span>, <span class="hljs-string">&#x27;autovacuum_freeze_min_age=(\d+)&#x27;</span>)::<span class="hljs-type">int</span>    <br>  ),    <br>  a.v3    <br>) <span class="hljs-keyword">as</span> xid_lower_to_minage,    <span class="hljs-comment">-- 如果触发FREEZE, 该表的事务ID年龄会降到多少    </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class="hljs-type">text</span>, <span class="hljs-string">&#x27;autovacuum_multixact_freeze_min_age=(\d+)&#x27;</span>)::<span class="hljs-type">int</span>    <br>  ),    <br>  a.v4    <br>) <span class="hljs-keyword">as</span> mxid_lower_to_minage,   <span class="hljs-comment">-- 如果触发FREEZE, 该表的并行事务ID年龄会降到多少    </span><br><span class="hljs-keyword">case</span>     <br>  <span class="hljs-keyword">when</span> v5 &lt;= age(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> relfrozenxid::<span class="hljs-type">text</span>::<span class="hljs-type">int</span>&lt;<span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">else</span> relfrozenxid <span class="hljs-keyword">end</span>) <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;YES&#x27;</span>    <br>  <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;NOT&#x27;</span>    <br><span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> vacuum_trigger_freeze1,    <span class="hljs-comment">-- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(事务ID年龄达到阈值)    </span><br><span class="hljs-keyword">case</span>     <br>  <span class="hljs-keyword">when</span> v6 &lt;= age(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> relminmxid::<span class="hljs-type">text</span>::<span class="hljs-type">int</span>&lt;<span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">else</span> relminmxid <span class="hljs-keyword">end</span>) <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;YES&#x27;</span>    <br>  <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;NOT&#x27;</span>    <br><span class="hljs-keyword">end</span> <span class="hljs-keyword">as</span> vacuum_trigger_freeze2,    <span class="hljs-comment">-- 如果手工执行VACUUM, 是否会触发FREEZE, 触发起因(并行事务ID年龄达到阈值)    </span><br>reloptions                        <span class="hljs-comment">-- 表级参数, 优先. 例如是否开启自动垃圾回收, autovacuum_freeze_max_age, autovacuum_freeze_table_age, autovacuum_multixact_freeze_max_age, autovacuum_multixact_freeze_table_age    </span><br><span class="hljs-keyword">from</span> pg_class     <br>  <span class="hljs-keyword">where</span> relkind <span class="hljs-keyword">in</span> (<span class="hljs-string">&#x27;r&#x27;</span>,<span class="hljs-string">&#x27;m&#x27;</span>)    <br>) e     <br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span>     <br>  least(e.remain_ages_xid , e.remain_ages_mxid),  <span class="hljs-comment">-- 排在越前, 越先触发自动FREEZE, 即风暴来临的预测    </span><br>  pg_total_relation_size(reloid) <span class="hljs-keyword">desc</span>   <span class="hljs-comment">-- 同样剩余年龄, 表越大, 排越前    </span><br>;    <br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.v_freeze_stat <span class="hljs-keyword">as</span>    <br><span class="hljs-keyword">select</span>     <br>wb,                                                     <span class="hljs-comment">-- 第几个BATCH, 每个batch代表流逝100万个事务     </span><br>cnt,                                                    <span class="hljs-comment">-- 这个batch 有多少表    </span><br>pg_size_pretty(ssz) <span class="hljs-keyword">as</span> ssz1,                            <span class="hljs-comment">-- 这个batch 这些 表+TOAST+索引 有多少容量    </span><br>pg_size_pretty(ssz) <span class="hljs-keyword">as</span> ssz2,                            <span class="hljs-comment">-- 这个batch FREEZE 会导致多少读IO    </span><br>pg_size_pretty(ssz*<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> ssz3,                          <span class="hljs-comment">-- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    </span><br>pg_size_pretty(min_sz) <span class="hljs-keyword">as</span> ssz4,                         <span class="hljs-comment">-- 这个batch 最小的表多大    </span><br>pg_size_pretty(max_sz) <span class="hljs-keyword">as</span> ssz5,                         <span class="hljs-comment">-- 这个batch 最大的表多大    </span><br>pg_size_pretty(avg_sz) <span class="hljs-keyword">as</span> ssz6,                         <span class="hljs-comment">-- 这个batch 平均表多大    </span><br>pg_size_pretty(stddev_sz) <span class="hljs-keyword">as</span> ssz7,                      <span class="hljs-comment">-- 这个batch 表大小的方差, 越大, 说明表大小差异化明显    </span><br>min_rest_age,                                           <span class="hljs-comment">-- 这个batch 距离自动FREEZE最低剩余事务数    </span><br>max_rest_age,                                           <span class="hljs-comment">-- 这个batch 距离自动FREEZE最高剩余事务数    </span><br>stddev_rest_age,                                        <span class="hljs-comment">-- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    </span><br>corr_rest_age_sz,                                       <span class="hljs-comment">-- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 sz7 说明的问题越有价值    </span><br>round(<span class="hljs-number">100</span>*(ssz/(sum(ssz) <span class="hljs-keyword">over</span> ())), <span class="hljs-number">2</span>)||<span class="hljs-string">&#x27; %&#x27;</span> <span class="hljs-keyword">as</span> ratio   <span class="hljs-comment">-- 这个BATCH的容量占比，占比如果非常不均匀，说明有必要调整表级FREEZE参数，让占比均匀化    </span><br><span class="hljs-keyword">from</span>         <br>(    <br><span class="hljs-keyword">select</span> a.*, b.* <span class="hljs-keyword">from</span>     <br>(    <br><span class="hljs-keyword">select</span>     <br>  min(least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">as</span> v_min,   <span class="hljs-comment">-- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    </span><br>  max(least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">as</span> v_max    <span class="hljs-comment">-- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    </span><br><span class="hljs-keyword">from</span> v_freeze    <br>) <span class="hljs-keyword">as</span> a,    <br><span class="hljs-keyword">LATERAL</span> (  <span class="hljs-comment">-- 高级SQL    </span><br><span class="hljs-keyword">select</span>     <br>width_bucket(    <br>  least(remain_ages_xid, remain_ages_mxid),     <br>  a.v_min,    <br>  a.v_max,    <br>  greatest((a.v_max-a.v_min)/<span class="hljs-number">1000000</span>, <span class="hljs-number">1</span>)   <span class="hljs-comment">-- 100万个事务, 如果要更改统计例如，修改这个值即可    </span><br>) <span class="hljs-keyword">as</span> wb,      <br>count(*) <span class="hljs-keyword">as</span> cnt,     <br>sum(pg_total_relation_size(reloid)) <span class="hljs-keyword">as</span> ssz,     <br>stddev_samp(pg_total_relation_size(reloid) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">as</span> stddev_sz,     <br>min(pg_total_relation_size(reloid)) <span class="hljs-keyword">as</span> min_sz,     <br>max(pg_total_relation_size(reloid)) <span class="hljs-keyword">as</span> max_sz,     <br>avg(pg_total_relation_size(reloid)) <span class="hljs-keyword">as</span> avg_sz,     <br>min(least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">as</span> min_rest_age,     <br>max(least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">as</span> max_rest_age,     <br>stddev_samp(least(remain_ages_xid, remain_ages_mxid) <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">as</span> stddev_rest_age,     <br>corr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) <span class="hljs-keyword">as</span> corr_rest_age_sz     <br><span class="hljs-keyword">from</span> v_freeze     <br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> wb     <br>) <span class="hljs-keyword">as</span> b     <br>) t     <br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> wb; <br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.v_freeze_stat_detail <span class="hljs-keyword">as</span>      <br><span class="hljs-keyword">select</span>     <br>pg_size_pretty(t.ssz) <span class="hljs-keyword">as</span> ssz2,     <span class="hljs-comment">-- 这个batch FREEZE 会导致多少读IO (表+TOAST+索引)    </span><br>pg_size_pretty(t.ssz*<span class="hljs-number">3</span>) <span class="hljs-keyword">as</span> ssz3,   <span class="hljs-comment">-- 这个batch FREEZE 最多可能会导致多少写IO (通常三份 : 数据文件, WAL FULL PAGE, WAL)    </span><br>pg_size_pretty(t.ssz_sum) <span class="hljs-keyword">as</span> ssz4, <span class="hljs-comment">-- 所有batch 所有表的总大小  (表+TOAST+索引)    </span><br>round(<span class="hljs-number">100</span>*(t.ssz/t.ssz_sum), <span class="hljs-number">2</span>)||<span class="hljs-string">&#x27; %&#x27;</span> <span class="hljs-keyword">as</span> ratio_batch,     <span class="hljs-comment">-- 这个BATCH的容量占比，目标是让所有BATCH占比尽量一致    </span><br>round(<span class="hljs-number">100</span>*(pg_total_relation_size(t.reloid)/t.ssz), <span class="hljs-number">2</span>)||<span class="hljs-string">&#x27; %&#x27;</span> <span class="hljs-keyword">as</span> ratio_table,     <span class="hljs-comment">-- 这个表占整个batch的容量占比，大表尽量错开freeze    </span><br>t.*      <br><span class="hljs-keyword">from</span>         <br>(    <br><span class="hljs-keyword">select</span> a.*, b.* <span class="hljs-keyword">from</span>       <br>(    <br>  <span class="hljs-keyword">select</span>     <br>    min(least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">as</span> v_min,   <span class="hljs-comment">-- 整个数据库中离自动FREEZE的 最小 剩余事务ID数    </span><br>    max(least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">as</span> v_max    <span class="hljs-comment">-- 整个数据库中离自动FREEZE的 最大 剩余事务ID数    </span><br>  <span class="hljs-keyword">from</span> v_freeze     <br>) <span class="hljs-keyword">as</span> a,     <br><span class="hljs-keyword">LATERAL</span> (     <span class="hljs-comment">-- 高级SQL    </span><br><span class="hljs-keyword">select</span>     <br>  count(*) <span class="hljs-keyword">over</span> w <span class="hljs-keyword">as</span> cnt,                                                <span class="hljs-comment">-- 这个batch 有多少表      </span><br>  sum(pg_total_relation_size(reloid)) <span class="hljs-keyword">over</span> () <span class="hljs-keyword">as</span> ssz_sum,                <span class="hljs-comment">-- 所有batch 所有表的总大小  (表+TOAST+索引)    </span><br>  sum(pg_total_relation_size(reloid)) <span class="hljs-keyword">over</span> w <span class="hljs-keyword">as</span> ssz,                     <span class="hljs-comment">-- 这个batch 的表大小总和 (表+TOAST+索引)    </span><br>  pg_size_pretty(min(pg_total_relation_size(reloid)) <span class="hljs-keyword">over</span> w) <span class="hljs-keyword">as</span> min_sz,  <span class="hljs-comment">-- 这个batch 最小的表多大    </span><br>  pg_size_pretty(max(pg_total_relation_size(reloid)) <span class="hljs-keyword">over</span> w) <span class="hljs-keyword">as</span> max_sz,  <span class="hljs-comment">-- 这个batch 最大的表多大    </span><br>  pg_size_pretty(avg(pg_total_relation_size(reloid)) <span class="hljs-keyword">over</span> w) <span class="hljs-keyword">as</span> avg_sz,  <span class="hljs-comment">-- 这个batch 平均表多大    </span><br>  pg_size_pretty(stddev_samp(pg_total_relation_size(reloid)) <span class="hljs-keyword">over</span> w) <span class="hljs-keyword">as</span> stddev_sz,  <span class="hljs-comment">-- 这个batch 表大小的方差, 越大, 说明表大小差异化明显                                                                                                                 </span><br>  min(least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">over</span> w <span class="hljs-keyword">as</span> min_rest_age,             <span class="hljs-comment">-- 这个batch 距离自动FREEZE最低剩余事务数                                                                                                                             </span><br>  max(least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">over</span> w <span class="hljs-keyword">as</span> max_rest_age,             <span class="hljs-comment">-- 这个batch 距离自动FREEZE最高剩余事务数                                                                                                                             </span><br>  stddev_samp(least(remain_ages_xid, remain_ages_mxid)) <span class="hljs-keyword">over</span> w <span class="hljs-keyword">as</span> stddev_rest_age,  <span class="hljs-comment">-- 这个batch 距离自动FREEZE剩余事务数的方差, 越小，说明这个batch触发freeze将越平缓, 越大, 说明这个batch将有可能在某些点集中触发freeze (但是可能集中触发的都是小表)    </span><br>  corr(least(remain_ages_xid, remain_ages_mxid), pg_total_relation_size(reloid)) <span class="hljs-keyword">over</span> w <span class="hljs-keyword">as</span> corr_rest_age_sz,  <span class="hljs-comment">-- 表大小与距离自动freeze剩余事务数的相关性，相关性越强(值趋向1或-1) stddev_rest_age 与 stddev_sz 说明的问题越有价值    </span><br>  t1.*     <br><span class="hljs-keyword">from</span>     <br>  (    <br>  <span class="hljs-keyword">select</span>     <br>    width_bucket(    <br>      least(tt.remain_ages_xid, tt.remain_ages_mxid),     <br>      a.v_min,    <br>      a.v_max,    <br>      greatest((a.v_max-a.v_min)/<span class="hljs-number">1000000</span>, <span class="hljs-number">1</span>)         <span class="hljs-comment">-- 100万个事务, 如果要更改统计例如，修改这个值即可    </span><br>    )     <br>    <span class="hljs-keyword">as</span> wb,                                           <span class="hljs-comment">-- 第几个BATCH, 每个batch代表流逝100万个事务      </span><br>    * <span class="hljs-keyword">from</span> v_freeze tt    <br>  ) <span class="hljs-keyword">as</span> t1      <br>  <span class="hljs-keyword">window</span> w <span class="hljs-keyword">as</span>     <br>  (    <br>    <span class="hljs-keyword">partition</span> <span class="hljs-keyword">by</span> t1.wb     <br>  )     <br>) <span class="hljs-keyword">as</span> b    <br>) t    <br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span>     <br>  t.wb,      <br>  least(t.remain_ages_xid, t.remain_ages_mxid),       <br>  pg_total_relation_size(t.reloid) <span class="hljs-keyword">desc</span>       <br>;      <br>  <br><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.top20freezebigtable <span class="hljs-keyword">as</span> <br><span class="hljs-keyword">select</span> relowner::<span class="hljs-type">regrole</span>, relnamespace::<span class="hljs-type">regnamespace</span>, relname, <br>age(relfrozenxid),pg_size_pretty(pg_total_relation_size(<span class="hljs-type">oid</span>)) , <span class="hljs-comment">-- 当前年龄 </span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class="hljs-type">text</span>, <span class="hljs-string">&#x27;autovacuum_freeze_max_age=(\d+)&#x27;</span>)::<span class="hljs-type">int</span>,     <br>    substring(reloptions::<span class="hljs-type">text</span>, <span class="hljs-string">&#x27;autovacuum_freeze_table_age=(\d+)&#x27;</span>)::<span class="hljs-type">int</span>     <br>  ),    <br>  current_setting(<span class="hljs-string">&#x27;autovacuum_freeze_max_age&#x27;</span>)::<span class="hljs-type">int</span>   <br>)    <br>-    <br>age(<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> relfrozenxid::<span class="hljs-type">text</span>::<span class="hljs-type">int</span>&lt;<span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">else</span> relfrozenxid <span class="hljs-keyword">end</span>)     <br><span class="hljs-keyword">as</span> remain_ages_xid,  <span class="hljs-comment">-- 再产生多少个事务后, 自动垃圾回收会触发FREEZE, 起因为事务ID</span><br>coalesce(    <br>  least(    <br>    substring(reloptions::<span class="hljs-type">text</span>, <span class="hljs-string">&#x27;autovacuum_freeze_min_age=(\d+)&#x27;</span>)::<span class="hljs-type">int</span>    <br>  ),    <br>  current_setting(<span class="hljs-string">&#x27;vacuum_freeze_min_age&#x27;</span>)::<span class="hljs-type">int</span>   <br>) <span class="hljs-keyword">as</span> xid_lower_to_minage    <span class="hljs-comment">-- 如果触发FREEZE, 该表的事务ID年龄会降到多少  </span><br><span class="hljs-keyword">from</span> pg_class <span class="hljs-keyword">where</span> relkind=<span class="hljs-string">&#x27;r&#x27;</span> <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> pg_total_relation_size(<span class="hljs-type">oid</span>) <span class="hljs-keyword">desc</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">20</span>; <br></code></pre></td></tr></table></figure>
<h1 id="未归档wal文件"><a href="#未归档wal文件" class="headerlink" title="未归档wal文件"></a>未归档wal文件</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.arch_undone <span class="hljs-keyword">as</span> <br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> pg_ls_archive_statusdir() <span class="hljs-keyword">where</span> <span class="hljs-type">name</span> !~ <span class="hljs-string">&#x27;done$&#x27;</span>;<br></code></pre></td></tr></table></figure>
<h1 id="归档任务状态"><a href="#归档任务状态" class="headerlink" title="归档任务状态"></a>归档任务状态</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.arch_status <span class="hljs-keyword">as</span><br><span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> pg_stat_get_archiver();<br></code></pre></td></tr></table></figure>
<h1 id="wal空间占用"><a href="#wal空间占用" class="headerlink" title="wal空间占用"></a>wal空间占用</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.walsize <span class="hljs-keyword">as</span> <br><span class="hljs-keyword">select</span> pg_size_pretty(sum(size)) <span class="hljs-keyword">from</span> pg_ls_waldir();<br></code></pre></td></tr></table></figure>
<h1 id="系统强制保留wal大小"><a href="#系统强制保留wal大小" class="headerlink" title="系统强制保留wal大小"></a>系统强制保留wal大小</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.wal_keep_size <span class="hljs-keyword">as</span><br><span class="hljs-keyword">with</span> a <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> setting <span class="hljs-keyword">from</span> pg_settings <span class="hljs-keyword">where</span> <span class="hljs-type">name</span>=<span class="hljs-string">&#x27;wal_keep_segments&#x27;</span>) , b <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> setting,unit <span class="hljs-keyword">from</span> pg_settings <span class="hljs-keyword">where</span> <span class="hljs-type">name</span>=<span class="hljs-string">&#x27;wal_segment_size&#x27;</span>) <span class="hljs-keyword">select</span> pg_size_pretty(a.setting::<span class="hljs-type">int8</span>*b.setting::<span class="hljs-type">int8</span>) <span class="hljs-keyword">from</span> a,b;<br></code></pre></td></tr></table></figure>
<h1 id="长事务、prepared-statement"><a href="#长事务、prepared-statement" class="headerlink" title="长事务、prepared statement"></a>长事务、prepared statement</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.long_snapshot <span class="hljs-keyword">as</span> <br><span class="hljs-keyword">with</span> a <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> min(<span class="hljs-keyword">transaction</span>::<span class="hljs-type">Text</span>::<span class="hljs-type">int8</span>) m <span class="hljs-keyword">from</span> pg_prepared_xacts ),<br>b <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> txid_snapshot_xmin(txid_current_snapshot())::<span class="hljs-type">text</span>::<span class="hljs-type">int8</span> <span class="hljs-keyword">as</span> m),<br>c <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> min(least(backend_xid::<span class="hljs-type">text</span>::<span class="hljs-type">int8</span>,backend_xmin::<span class="hljs-type">text</span>::<span class="hljs-type">int8</span>)) m <span class="hljs-keyword">from</span> pg_stat_activity ),<br>d <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> datname,usename,pid,query_start,xact_start,now(),wait_event,query <span class="hljs-keyword">from</span> pg_stat_activity <span class="hljs-keyword">where</span> backend_xid <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">or</span> backend_xmin <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span><br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> least(backend_xid::<span class="hljs-type">text</span>::<span class="hljs-type">int8</span>,backend_xmin::<span class="hljs-type">text</span>::<span class="hljs-type">int8</span>) <span class="hljs-keyword">limit</span> <span class="hljs-number">1</span>),<br>e <span class="hljs-keyword">as</span> (<span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> pg_prepared_xacts <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> <span class="hljs-keyword">transaction</span>::<span class="hljs-type">Text</span>::<span class="hljs-type">int8</span> <span class="hljs-keyword">limit</span> <span class="hljs-number">1</span>)<br><span class="hljs-keyword">select</span> b.m-least(a.m,c.m),d.*,e.* <span class="hljs-keyword">from</span> a,b,c,d <span class="hljs-keyword">left join</span> e <span class="hljs-keyword">on</span> (<span class="hljs-number">1</span>=<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure>
<h1 id="重置top-query统计计数器-通常在高峰期来临前可以重置-防止结果干扰"><a href="#重置top-query统计计数器-通常在高峰期来临前可以重置-防止结果干扰" class="headerlink" title="重置top query统计计数器(通常在高峰期来临前可以重置,防止结果干扰)"></a>重置top query统计计数器(通常在高峰期来临前可以重置,防止结果干扰)</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">select</span> pg_stat_statements_reset();<br></code></pre></td></tr></table></figure>
<h1 id="查询活跃会话数-如果超过CPU核数-说明数据库非常非常繁忙-需要注意优化"><a href="#查询活跃会话数-如果超过CPU核数-说明数据库非常非常繁忙-需要注意优化" class="headerlink" title="查询活跃会话数, 如果超过CPU核数, 说明数据库非常非常繁忙, 需要注意优化"></a>查询活跃会话数, 如果超过CPU核数, 说明数据库非常非常繁忙, 需要注意优化</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.session_acting_cnt <span class="hljs-keyword">as</span> <span class="hljs-keyword">select</span> count(*) <span class="hljs-keyword">from</span> pg_stat_activity <span class="hljs-keyword">where</span> wait_event <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">and</span> (backend_xid <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">or</span> backend_xmin <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>); <br></code></pre></td></tr></table></figure>
<h1 id="当前活跃会话"><a href="#当前活跃会话" class="headerlink" title="当前活跃会话"></a>当前活跃会话</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.sessions <span class="hljs-keyword">as</span> <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> pg_stat_activity <span class="hljs-keyword">where</span> wait_event <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">and</span> (backend_xid <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">or</span> backend_xmin <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>);  <br></code></pre></td></tr></table></figure>
<h1 id="查看锁等待"><a href="#查看锁等待" class="headerlink" title="查看锁等待"></a>查看锁等待</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">view</span> dba.locks <span class="hljs-keyword">as</span> <span class="hljs-keyword">with</span>      <br>t_wait <span class="hljs-keyword">as</span>      <br>(      <br>  <span class="hljs-keyword">select</span> a.mode,a.locktype,a.<span class="hljs-keyword">database</span>,a.relation,a.page,a.tuple,a.classid,a.granted,     <br>  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,      <br>  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     <br>    <span class="hljs-keyword">from</span> pg_locks a,pg_stat_activity b <span class="hljs-keyword">where</span> a.pid=b.pid <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> a.granted     <br>),     <br>t_run <span class="hljs-keyword">as</span>     <br>(     <br>  <span class="hljs-keyword">select</span> a.mode,a.locktype,a.<span class="hljs-keyword">database</span>,a.relation,a.page,a.tuple,a.classid,a.granted,     <br>  a.objid,a.objsubid,a.pid,a.virtualtransaction,a.virtualxid,a.transactionid,a.fastpath,     <br>  b.state,b.query,b.xact_start,b.query_start,b.usename,b.datname,b.client_addr,b.client_port,b.application_name     <br>    <span class="hljs-keyword">from</span> pg_locks a,pg_stat_activity b <span class="hljs-keyword">where</span> a.pid=b.pid <span class="hljs-keyword">and</span> a.granted     <br>),     <br>t_overlap <span class="hljs-keyword">as</span>     <br>(     <br>  <span class="hljs-keyword">select</span> r.* <span class="hljs-keyword">from</span> t_wait w <span class="hljs-keyword">join</span> t_run r <span class="hljs-keyword">on</span>     <br>  (     <br>    r.locktype <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.locktype <span class="hljs-keyword">and</span>     <br>    r.<span class="hljs-keyword">database</span> <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.<span class="hljs-keyword">database</span> <span class="hljs-keyword">and</span>     <br>    r.relation <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.relation <span class="hljs-keyword">and</span>     <br>    r.page <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.page <span class="hljs-keyword">and</span>     <br>    r.tuple <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.tuple <span class="hljs-keyword">and</span>     <br>    r.virtualxid <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.virtualxid <span class="hljs-keyword">and</span>     <br>    r.transactionid <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.transactionid <span class="hljs-keyword">and</span>     <br>    r.classid <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.classid <span class="hljs-keyword">and</span>     <br>    r.objid <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.objid <span class="hljs-keyword">and</span>     <br>    r.objsubid <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span> w.objsubid <span class="hljs-keyword">and</span>     <br>    r.pid &lt;&gt; w.pid     <br>  )      <br>),      <br>t_unionall <span class="hljs-keyword">as</span>      <br>(      <br>  <span class="hljs-keyword">select</span> r.* <span class="hljs-keyword">from</span> t_overlap r      <br>  <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span>      <br>  <span class="hljs-keyword">select</span> w.* <span class="hljs-keyword">from</span> t_wait w      <br>)      <br><span class="hljs-keyword">select</span> locktype,datname,relation::<span class="hljs-type">regclass</span>,page,tuple,virtualxid,transactionid::<span class="hljs-type">text</span>,classid::<span class="hljs-type">regclass</span>,objid,objsubid,     <br>string_agg(     <br><span class="hljs-string">&#x27;Pid: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> pid <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> pid::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||chr(<span class="hljs-number">10</span>)||     <br><span class="hljs-string">&#x27;Lock_Granted: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> granted <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> granted::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , Mode: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> mode <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> mode::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , FastPath: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> fastpath <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> fastpath::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , VirtualTransaction: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> virtualtransaction <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> virtualtransaction::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , Session_State: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> state <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> state::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||chr(<span class="hljs-number">10</span>)||     <br><span class="hljs-string">&#x27;Username: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> usename <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> usename::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , Database: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> datname <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> datname::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , Client_Addr: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> client_addr <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> client_addr::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , Client_Port: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> client_port <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> client_port::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , Application_Name: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> application_name <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> application_name::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||chr(<span class="hljs-number">10</span>)||      <br><span class="hljs-string">&#x27;Xact_Start: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> xact_start <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> xact_start::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , Query_Start: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> query_start <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> query_start::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , Xact_Elapse: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (now()-xact_start) <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> (now()-xact_start)::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||<span class="hljs-string">&#x27; , Query_Elapse: &#x27;</span>||<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (now()-query_start) <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> (now()-query_start)::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>||chr(<span class="hljs-number">10</span>)||      <br><span class="hljs-string">&#x27;SQL (Current SQL in Transaction): &#x27;</span>||chr(<span class="hljs-number">10</span>)||    <br><span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> query <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;NULL&#x27;</span> <span class="hljs-keyword">else</span> query::<span class="hljs-type">text</span> <span class="hljs-keyword">end</span>,      <br>chr(<span class="hljs-number">10</span>)||<span class="hljs-string">&#x27;--------&#x27;</span>||chr(<span class="hljs-number">10</span>)      <br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span>      <br>  (  <span class="hljs-keyword">case</span> mode      <br>    <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;INVALID&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">0</span>     <br>    <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;AccessShareLock&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1</span>     <br>    <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;RowShareLock&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">2</span>     <br>    <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;RowExclusiveLock&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">3</span>     <br>    <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;ShareUpdateExclusiveLock&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">4</span>     <br>    <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;ShareLock&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">5</span>     <br>    <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;ShareRowExclusiveLock&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">6</span>     <br>    <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;ExclusiveLock&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">7</span>     <br>    <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;AccessExclusiveLock&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-number">8</span>     <br>    <span class="hljs-keyword">else</span> <span class="hljs-number">0</span>     <br>  <span class="hljs-keyword">end</span>  ) <span class="hljs-keyword">desc</span>,     <br>  (<span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> granted <span class="hljs-keyword">then</span> <span class="hljs-number">0</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>)    <br>) <span class="hljs-keyword">as</span> lock_conflict    <br><span class="hljs-keyword">from</span> t_unionall     <br><span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span>     <br>locktype,datname,relation,page,tuple,virtualxid,transactionid::<span class="hljs-type">text</span>,classid,objid,objsubid ;<br></code></pre></td></tr></table></figure>
<h1 id="查看索引支持类型"><a href="#查看索引支持类型" class="headerlink" title="查看索引支持类型"></a>查看索引支持类型</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">SELECT</span><br>    am.amname <span class="hljs-keyword">AS</span> index_method,<br>    opc.opcname <span class="hljs-keyword">AS</span> opclass_name,<br>    opc.opcintype::<span class="hljs-type">regtype</span> <span class="hljs-keyword">AS</span> indexed_type,<br>    opc.opcdefault <span class="hljs-keyword">AS</span> is_default<br><span class="hljs-keyword">FROM</span><br>    pg_am am,<br>    pg_opclass opc<br><span class="hljs-keyword">WHERE</span><br>    opc.opcmethod = am.oid<br><span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span><br>    index_method,<br>    opclass_name;<br><span class="hljs-keyword">SELECT</span><br>    amname,<br>    opcname,<br>    opcintype::<span class="hljs-type">regtype</span>,<br>    opckeytype::<span class="hljs-type">regtype</span>,<br>    opcdefault<br><span class="hljs-keyword">FROM</span><br>    pg_am am,<br>    pg_opclass opc<br><span class="hljs-keyword">WHERE</span><br>    am.oid = opc.opcmethod<br>    <span class="hljs-keyword">AND</span> amname = <span class="hljs-string">&#x27;gin&#x27;</span>;<br><br><span class="hljs-keyword">SELECT</span><br>    <span class="hljs-type">oid</span>,<br>    oprnegate,<br>    oprname,<br>    oprcode,<br>    oprresult::<span class="hljs-type">regtype</span>,<br>    oprleft::<span class="hljs-type">regtype</span>,<br>    oprright::<span class="hljs-type">regtype</span>,<br>    oprcanmerge<br><span class="hljs-keyword">FROM</span><br>    pg_operator;<br><br></code></pre></td></tr></table></figure>
<h1 id="判断ip是否在某一网段内"><a href="#判断ip是否在某一网段内" class="headerlink" title="判断ip是否在某一网段内"></a>判断ip是否在某一网段内</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR REPLACE</span> <span class="hljs-keyword">FUNCTION</span> <span class="hljs-built_in">public</span>.is_same_network (ip1 ip4, ip2 ip4, mask <span class="hljs-type">integer</span>)<br>    <span class="hljs-keyword">RETURNS</span> <span class="hljs-type">boolean</span><br><span class="hljs-keyword">AS</span><br>$$<br><span class="pgsql"><span class="hljs-keyword">DECLARE</span></span><br><span class="pgsql">    is_same_network <span class="hljs-type">boolean</span>;</span><br><span class="pgsql"><span class="hljs-keyword">BEGIN</span></span><br>    IF mask &gt; 32 OR mask &lt; 0 THEN<br><span class="pgsql">        <span class="hljs-keyword">raise</span></span><br><span class="pgsql">        <span class="hljs-keyword">exception</span> <span class="hljs-string">&#x27;The mask must be between 0 and 32&#x27;</span>;</span><br><span class="pgsql">    <span class="hljs-keyword">END</span> <span class="hljs-keyword">IF</span>;</span><br> <br><span class="pgsql">    <span class="hljs-keyword">EXECUTE</span> format(<span class="hljs-string">&#x27;select (~($1 # $2))::bigint::bit(32)::bit(%I)::text ~ &#x27;&#x27;^1+$&#x27;&#x27;&#x27;</span>, mask) <span class="hljs-keyword">using</span> ip1, ip2 <span class="hljs-keyword">into</span> is_same_network;</span><br><span class="pgsql">    <span class="hljs-keyword">RETURN</span> is_same_network;</span><br><span class="pgsql"><span class="hljs-keyword">exception</span></span><br><span class="pgsql">    <span class="hljs-keyword">WHEN</span> OTHERS <span class="hljs-keyword">THEN</span></span><br><span class="pgsql">        <span class="hljs-keyword">raise</span> <span class="hljs-keyword">NOTICE</span> <span class="hljs-string">&#x27;%&#x27;</span>, <span class="hljs-built_in">SQLERRM</span>;</span><br><span class="pgsql">    <span class="hljs-keyword">RETURN</span> <span class="hljs-keyword">FALSE</span>;</span><br><span class="pgsql"><span class="hljs-keyword">END</span>;</span><br><span class="ruby">$$</span> <span class="hljs-keyword">language</span> plpgsql;<br></code></pre></td></tr></table></figure>
<h1 id="指定字符替换"><a href="#指定字符替换" class="headerlink" title="指定字符替换"></a>指定字符替换</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">postgres=# <span class="hljs-keyword">SELECT</span> regexp_replace(<span class="hljs-string">&#x27;foobarbaz&#x27;</span>, <span class="hljs-string">&#x27;b(..)&#x27;</span>, <span class="hljs-string">&#x27;X\1Y&#x27;</span>, <span class="hljs-string">&#x27;g&#x27;</span>);<br> regexp_replace <br><span class="hljs-comment">----------------</span><br> fooXarYXazY<br>(<span class="hljs-number">1</span> <span class="hljs-keyword">row</span>)<br><br></code></pre></td></tr></table></figure>
<h1 id="SQL实现圣诞树"><a href="#SQL实现圣诞树" class="headerlink" title="SQL实现圣诞树"></a>SQL实现圣诞树</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">mydb=# <span class="hljs-keyword">WITH</span> leaf <span class="hljs-keyword">AS</span><br> (<span class="hljs-keyword">SELECT</span> lpad(rpad(<span class="hljs-string">&#x27;*&#x27;</span>, (id - <span class="hljs-number">1</span>) * <span class="hljs-number">2</span> + <span class="hljs-number">1</span>, <span class="hljs-string">&#x27;*&#x27;</span>), id + <span class="hljs-number">20</span>) leaf,<br>         id<br>    <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">3</span>) <span class="hljs-keyword">AS</span> t(id)),<br>lv <span class="hljs-keyword">AS</span><br> (<span class="hljs-keyword">SELECT</span> id lv <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">5</span>) <span class="hljs-keyword">AS</span> t(id)),<br>leafs <span class="hljs-keyword">AS</span><br> (<span class="hljs-keyword">SELECT</span> lpad(rpad(<span class="hljs-string">&#x27;*&#x27;</span>, ((row_number() <span class="hljs-keyword">over</span>()) ::<span class="hljs-type">INT</span> - <span class="hljs-number">1</span>) * <span class="hljs-number">2</span> + <span class="hljs-number">1</span> + (lv - <span class="hljs-number">1</span>) * <span class="hljs-number">2</span>, <span class="hljs-string">&#x27;*&#x27;</span>), (row_number()<br>                <span class="hljs-keyword">over</span>())<br>               ::<span class="hljs-type">INT</span> + <span class="hljs-number">20</span> + lv) leaf<br>    <span class="hljs-keyword">FROM</span> leaf,<br>         lv),<br>root <span class="hljs-keyword">AS</span><br> (<span class="hljs-keyword">SELECT</span> lpad(rpad(<span class="hljs-string">&#x27;*&#x27;</span>, <span class="hljs-number">5</span>, <span class="hljs-string">&#x27;*&#x27;</span>), <span class="hljs-number">24</span>) <span class="hljs-keyword">FROM</span> generate_series(<span class="hljs-number">1</span>, <span class="hljs-number">4</span>) <span class="hljs-keyword">AS</span> t(id))<br><span class="hljs-keyword">SELECT</span> leaf<br>  <span class="hljs-keyword">FROM</span> leafs<br><span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span><br><span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> root;<br>                   leaf                  <br><span class="hljs-comment">------------------------------------------</span><br>                      *<br>                    *****<br>                  *********<br>                *************<br>              *****************<br>                 ***********<br>               ***************<br>             *******************<br>           ***********************<br>         ***************************<br>            *********************<br>          *************************<br>        *****************************<br>      *********************************<br>    *************************************<br>                    *****<br>                    *****<br>                    *****<br>                    *****<br>(<span class="hljs-number">19</span> <span class="hljs-keyword">rows</span>)<br> <br>mydb=#<br><br></code></pre></td></tr></table></figure>
<h1 id="生成随机中文"><a href="#生成随机中文" class="headerlink" title="生成随机中文"></a>生成随机中文</h1><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">replace</span> <span class="hljs-keyword">function</span> gen_hanzi(<span class="hljs-built_in">int</span>) <span class="hljs-keyword">returns</span> <span class="hljs-built_in">text</span> <span class="hljs-keyword">as</span> $$  <br><span class="hljs-keyword">declare</span>  <br>  res <span class="hljs-built_in">text</span>;  <br><span class="hljs-keyword">begin</span>  <br>  <span class="hljs-keyword">if</span> $<span class="hljs-number">1</span> &gt;=<span class="hljs-number">1</span> <span class="hljs-keyword">then</span>  <br>    <span class="hljs-keyword">select</span> string_agg(<span class="hljs-keyword">chr</span>(<span class="hljs-number">19968</span>+(random()*<span class="hljs-number">20901</span>)::<span class="hljs-built_in">int</span>), <span class="hljs-string">&#x27;&#x27;</span>) <span class="hljs-keyword">into</span> res <span class="hljs-keyword">from</span> generate_series(<span class="hljs-number">1</span>,$<span class="hljs-number">1</span>);  <br>    return res;  <br>  <span class="hljs-keyword">end</span> <span class="hljs-keyword">if</span>;  <br>  return null;  <br><span class="hljs-keyword">end</span>;  <br>$$ language plpgsql strict;<br></code></pre></td></tr></table></figure>
<h1 id="生成随机时间"><a href="#生成随机时间" class="headerlink" title="生成随机时间"></a>生成随机时间</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">or replace</span> <span class="hljs-keyword">function</span> get_rand_ts() <span class="hljs-keyword">returns</span> <span class="hljs-type">timestamp</span> <span class="hljs-keyword">as</span> $$  <br><span class="pgsql">  <span class="hljs-keyword">select</span> now()::<span class="hljs-type">timestamp</span>  +  ((<span class="hljs-number">1000</span>*random())::<span class="hljs-type">int</span>::<span class="hljs-type">text</span>||<span class="hljs-string">&#x27; days&#x27;</span>)::<span class="hljs-type">interval</span>;            </span><br><span class="ruby">$$</span> <span class="hljs-keyword">language</span> <span class="hljs-keyword">sql</span> <span class="hljs-keyword">strict</span>;  <br></code></pre></td></tr></table></figure>
<h1 id="找出index-维护SQL"><a href="#找出index-维护SQL" class="headerlink" title="找出index 维护SQL"></a>找出index 维护SQL</h1><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span><br>        <span class="hljs-keyword">CASE</span><br>                <span class="hljs-keyword">WHEN</span> flag = <span class="hljs-number">1</span> <span class="hljs-keyword">THEN</span><br>                        <span class="hljs-keyword">CASE</span><br>                        <span class="hljs-keyword">WHEN</span> indexdef !~ <span class="hljs-string">&#x27; WHERE &#x27;</span> <span class="hljs-keyword">THEN</span><br>                                regexp_replace(indexdef, E<span class="hljs-string">&#x27;(INDEX )(.+)( ON )(.+\\)\$)&#x27;</span>  ,E<span class="hljs-string">&#x27; \\1 CONCURRENTLY \\3 \\4 TABLESPACE  pg_default &#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>) ||<span class="hljs-string">&#x27;; &#x27;</span><br>                        <span class="hljs-keyword">ELSE</span><br>                                regexp_replace(indexdef, E<span class="hljs-string">&#x27;(INDEX )(.+)( ON )(.+)( WHERE )&#x27;</span>  ,E<span class="hljs-string">&#x27; \\1 CONCURRENTLY \\3 \\4 TABLESPACE  pg_default \\5 &#x27;</span>,<span class="hljs-string">&#x27;g&#x27;</span>) ||<span class="hljs-string">&#x27;; &#x27;</span><br>                        <span class="hljs-keyword">END</span><br>                <span class="hljs-keyword">WHEN</span> flag = <span class="hljs-number">2</span> <span class="hljs-keyword">THEN</span><br>                                <span class="hljs-string">&#x27;ANALYZE VERBOSE &#x27;</span>||schemaname||<span class="hljs-string">&#x27;.&#x27;</span>||tablename||<span class="hljs-string">&#x27; ; select pg_sleep(600) ; DROP INDEX CONCURRENTLY IF EXISTS &#x27;</span>||schemaname||<span class="hljs-string">&#x27;.&#x27;</span>||indexname||<span class="hljs-string">&#x27;; &#x27;</span><br>        <span class="hljs-keyword">END</span><br><span class="hljs-keyword">from</span><br>        (<br>        <span class="hljs-keyword">select</span><br>                generate_series(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> flag,<br>                indexdef,<br>                indexname,<br>                tablename,<br>                pi.schemaname<br>        <span class="hljs-keyword">from</span><br>                pg_indexes <span class="hljs-keyword">pi</span><br>        <span class="hljs-keyword">join</span><br>                pg_namespace n<br>          <span class="hljs-keyword">on</span><br>                pi.schemaname = n.nspname<br>        <span class="hljs-keyword">join</span><br>                pg_class pcl<br>          <span class="hljs-keyword">on</span><br>                pcl.relnamespace = n.oid<br>                <span class="hljs-keyword">and</span> pcl.relname = pi.tablename<br>        <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span><br>                pg_constraint pco<br>          <span class="hljs-keyword">on</span><br>                pco.conname = pi.indexname<br>                <span class="hljs-keyword">and</span> pco.conrelid = pcl.oid<br>        <span class="hljs-keyword">where</span><br>                (pi.schemaname, pi.tablename) = (<span class="hljs-string">&#x27;mirror&#x27;</span>,<span class="hljs-string">&#x27;b2c_order&#x27;</span>)<br>                <span class="hljs-keyword">and</span> pco.contype <span class="hljs-keyword">is</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span>  <span class="hljs-string">&#x27;p&#x27;</span><br>                <span class="hljs-keyword">and</span> pco.contype <span class="hljs-keyword">is</span> <span class="hljs-keyword">distinct</span> <span class="hljs-keyword">from</span>  <span class="hljs-string">&#x27;u&#x27;</span><br>        <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span><br>                pi.schemaname, tablename, indexname, pg_table_size(schemaname||<span class="hljs-string">&#x27;.&#x27;</span>||indexname::<span class="hljs-built_in">text</span>) <span class="hljs-keyword">desc</span>, flag <span class="hljs-keyword">asc</span><br>        ) <span class="hljs-keyword">as</span> foo<br><span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span><br>       schemaname, tablename, indexname, pg_table_size(schemaname||<span class="hljs-string">&#x27;.&#x27;</span>||indexname::<span class="hljs-built_in">text</span>) <span class="hljs-keyword">desc</span>, flag <span class="hljs-keyword">asc</span><br>;<br></code></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a href="https://github.com/digoal/blog/blob/master/202005/20200509_02.md">德哥</a></p>
]]></content>
      <categories>
        <category>数据库</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
        <tag>DBA</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>微信聊天自动回复机器人代码</title>
    <url>/python/%E5%BE%AE%E4%BF%A1%E8%81%8A%E5%A4%A9%E8%87%AA%E5%8A%A8%E5%9B%9E%E5%A4%8D%E6%9C%BA%E5%99%A8%E4%BA%BA/</url>
    <content><![CDATA[<p>微信聊天自动回复小程序, 输入指定内容控制开关，以及添加附加内容等小功能,</p>
<a id="more"></a>
<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><br><span class="hljs-keyword">import</span> itchat<br><span class="hljs-keyword">import</span> re,requests<br><span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote,unquote<br><br>AUTO_REPLAY=<span class="hljs-number">0</span><br>BASEMSG = <span class="hljs-string">&#x27;&#x27;</span><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">robot</span>(<span class="hljs-params">data</span>):</span><br>    <span class="hljs-keyword">global</span> AUTO_REPLAY<br>    ini=<span class="hljs-string">&quot;&#123;&#x27;sessionId&#x27;:&#x27;09e2aca4d0a541f88eecc77c03a8b393&#x27;,&#x27;robotId&#x27;:&#x27;webbot&#x27;,&#x27;userId&#x27;:&#x27;462d49d3742745bb98f7538c42f9f874&#x27;,&#x27;body&#x27;:&#123;&#x27;content&#x27;:&#x27;&quot;</span> + data + <span class="hljs-string">&quot;&#x27;&#125;,&#x27;type&#x27;:&#x27;txt&#x27;&#125;&amp;ts=1529917589648&quot;</span><br>    url = <span class="hljs-string">&quot;http://i.xiaoi.com/robot/webrobot?&amp;callback=__webrobot_processMsg&amp;data=&quot;</span> + quote(ini)<br>    cookie = &#123;<span class="hljs-string">&quot;cnonce&quot;</span>: <span class="hljs-string">&quot;808116&quot;</span>, <span class="hljs-string">&quot;sig&quot;</span>: <span class="hljs-string">&quot;0c3021aa5552fe597bb55448b40ad2a90d2dead5&quot;</span>,<span class="hljs-string">&quot;XISESSIONID&quot;</span>: <span class="hljs-string">&quot;hlbnd1oiwar01dfje825gavcn&quot;</span>, <span class="hljs-string">&quot;nonce&quot;</span>: <span class="hljs-string">&quot;273765&quot;</span>, <span class="hljs-string">&quot;hibext_instdsigdip2&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>&#125;<br>    r = requests.get(url, cookies=cookie)<br>    <span class="hljs-comment">#print(type(r))</span><br>    <span class="hljs-comment">#json_r = r.json()</span><br>    <span class="hljs-comment">#print(json_r)</span><br>    pattern = re.compile(<span class="hljs-string">r&#x27;\&quot;fontColor\&quot;:0,\&quot;content\&quot;:\&quot;(.*?)\&quot;&#x27;</span>)<br>    result = pattern.findall(r.text)<br>        <span class="hljs-comment">#return result[1].replace(&quot;\\r\\n&quot;,&#x27;&#x27;)</span><br>        <span class="hljs-comment">#return result[1].replace(&quot;\\n&quot;,&#x27;&#x27;)</span><br>    <span class="hljs-keyword">return</span> result[<span class="hljs-number">1</span>].replace(<span class="hljs-string">&quot;\\r\\n&quot;</span>,<span class="hljs-string">&#x27;&#x27;</span>)<br><br><span class="hljs-keyword">import</span> re,requests<br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-keyword">from</span> urllib <span class="hljs-keyword">import</span> quote,unquote<br><span class="hljs-keyword">except</span> ImportError:<br>    <span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> quote,unquote<br><br><span class="hljs-keyword">import</span> json<br><br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">qingke_robot</span>(<span class="hljs-params">msg</span>):</span><br>    <span class="hljs-comment">#ssl._create_default_https_context = ssl._create_unverified_context</span><br>    url = <span class="hljs-string">r&quot;http://api.qingyunke.com/api.php?key=free&amp;appid=0&amp;msg=%s&quot;</span> % (quote(msg))<br><br>    <span class="hljs-keyword">try</span>:<br>            <span class="hljs-keyword">from</span> urllib.request <span class="hljs-keyword">import</span> urlopen<br>    <span class="hljs-keyword">except</span> ImportError:<br>            <span class="hljs-keyword">from</span> urllib2 <span class="hljs-keyword">import</span> urlopen<br><br>    result = urlopen(url)<br>    response = json.loads(result.read().decode(<span class="hljs-string">&quot;utf-8&quot;</span>))<br>    code = response[<span class="hljs-string">&#x27;result&#x27;</span>]<br>    <span class="hljs-keyword">if</span> code != <span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span><br>    content = response[<span class="hljs-string">&#x27;content&#x27;</span>].replace(<span class="hljs-string">&#x27;&#123;br&#125;&#x27;</span>,<span class="hljs-string">&#x27;\n&#x27;</span>)<br>    <span class="hljs-keyword">return</span> content<br><br><br><span class="hljs-comment"># 自动回复</span><br><span class="hljs-comment"># 封装好的装饰器，当接收到的消息是Text，即文字消息</span><br><span class="hljs-meta">@itchat.msg_register(&#x27;Text&#x27;)</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">text_reply</span>(<span class="hljs-params">msg</span>):</span><br>    <span class="hljs-keyword">global</span> BASEMSG<br>    <span class="hljs-keyword">global</span> AUTO_REPLAY<br>    <span class="hljs-comment"># 当消息不是由自己发出的时候</span><br>    <span class="hljs-comment">#return  u&quot;[主人暂时不在，我是周小秘]&#123;&#125;&quot;.format(tulin_robot(msg[&#x27;Text&#x27;]))</span><br>    <span class="hljs-comment">#return  u&quot;[主人暂时不在，我是周小秘]&#123;&#125;&quot;.format(robot(msg[&#x27;Text&#x27;]))</span><br><br>    <span class="hljs-keyword">if</span> msg[<span class="hljs-string">&#x27;Text&#x27;</span>].lower() == <span class="hljs-string">&quot;open&quot;</span>:<br>        AUTO_REPLAY=<span class="hljs-number">1</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;自动聊天功能已打开.&quot;</span><br>    <span class="hljs-keyword">elif</span> msg[<span class="hljs-string">&#x27;Text&#x27;</span>].lower() == <span class="hljs-string">&quot;close&quot;</span>:<br>        AUTO_REPLAY=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;自动聊天功能已关闭.&quot;</span><br>    <span class="hljs-keyword">elif</span> msg[<span class="hljs-string">&#x27;Text&#x27;</span>].lower() == <span class="hljs-string">&quot;add&quot;</span>:<br>        BASEMSG = <span class="hljs-string">&quot;[主人暂时不在，我是周小秘 ]:&quot;</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;添加附加内容成功&quot;</span><br>    <span class="hljs-keyword">elif</span> msg[<span class="hljs-string">&#x27;Text&#x27;</span>].lower() == <span class="hljs-string">&quot;del&quot;</span>:<br>        BASEMSG = <span class="hljs-string">&quot;&quot;</span><br>        AUTO_REPLAY=<span class="hljs-number">0</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;取消附加内容成功&quot;</span><br><br>    <span class="hljs-comment"># 回复给好友</span><br>    <span class="hljs-keyword">if</span> AUTO_REPLAY &gt; <span class="hljs-number">0</span> :<br>        <span class="hljs-keyword">if</span> BASEMSG != <span class="hljs-string">&quot;&quot;</span>:<br>            <span class="hljs-keyword">return</span> BASEMSG + qingke_robot(msg[<span class="hljs-string">&#x27;Text&#x27;</span>])<br>        <span class="hljs-keyword">return</span> qingke_robot(msg[<span class="hljs-string">&#x27;Text&#x27;</span>])<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    itchat.auto_login(enableCmdQR=<span class="hljs-number">2</span>)<br><br>    <span class="hljs-comment"># 获取自己的UserName</span><br>    myUserName = itchat.get_friends(update=<span class="hljs-literal">True</span>)[<span class="hljs-number">0</span>][<span class="hljs-string">&quot;UserName&quot;</span>]<br>    itchat.run(debug=<span class="hljs-literal">True</span>)<br>    <span class="hljs-comment">#print(qingke_robot(&quot;你好&quot;))</span><br><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>robot</tag>
        <tag>微信自动回复</tag>
      </tags>
  </entry>
  <entry>
    <title>PostgreSQL用户权限</title>
    <url>/PostgreSQL/PostgreSQL%E7%94%A8%E6%88%B7%E6%9D%83%E9%99%90/</url>
    <content><![CDATA[<p>PostgreSQL中role是权限的集合，没有区分用户和角色的概念，”CREATE USER” 为 “CREATE ROLE” 的别名，这两个命令几乎是完全相同的,唯一的区别是”CREATE USER” 命令创建的用户默认带有LOGIN属性，而”CREATE ROLE” 命令创建的用户默认不带LOGIN属性(CREATE USER is equivalent to CREATE ROLE except that CREATE USER assumes LOGIN by default, while CREATE ROLE does not)</p>
<p>为了方便用role的方式管理用户， 而不是每新建一个用户就授予权限一次.</p>
<a id="more"></a>
<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><p>收回PUBLIC用户组对模式public的所有权限， 并创建测试用表</p>
<figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">jintao@jintao-ThinkPad-L490:~$ psql <br>psql (<span class="hljs-number">14</span>devel)<br><span class="hljs-keyword">Type</span> &quot;help&quot; <span class="hljs-keyword">for</span> help.<br><br>mydb=# <span class="hljs-keyword">revoke</span> <span class="hljs-keyword">ALL</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">SCHEMA</span> <span class="hljs-built_in">public</span> <span class="hljs-keyword">from</span> <span class="hljs-built_in">PUBLIC</span>;<br><span class="hljs-keyword">REVOKE</span><br>mydb=# <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> test1(id <span class="hljs-type">int</span>);<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span><br>mydb=# <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test1 <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span><br>mydb=# <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> test1;<br> id <br><span class="hljs-comment">----</span><br>  <span class="hljs-number">1</span><br>(<span class="hljs-number">1</span> <span class="hljs-keyword">row</span>)<br><br>mydb=# <br><br></code></pre></td></tr></table></figure>
<h1 id="创建只读角色"><a href="#创建只读角色" class="headerlink" title="创建只读角色"></a>创建只读角色</h1><p>只对table, sequence, function 做了处理， 如type, procedure等类似<br><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">mydb</span>=# create role readonly;                                                 <br>CREATE ROLE<br><span class="hljs-attribute">mydb</span>=# grant SELECT on ALL tables <span class="hljs-keyword">in</span> schema public <span class="hljs-keyword">to</span> readonly ;    -- 赋予readonly对public模式下当前存在的表可读<br>GRANT<br><span class="hljs-attribute">mydb</span>=# grant EXECUTE on ALL functions <span class="hljs-keyword">in</span> schema public <span class="hljs-keyword">to</span> readonly ;    -- 赋予readonly对public模式下当前函数可执行<br>GRANT<br><span class="hljs-attribute">mydb</span>=# grant SELECT on ALL sequences <span class="hljs-keyword">in</span> schema public <span class="hljs-keyword">to</span> readonly ;      -- 赋予readonly对public模式下当前序列的可读<br>GRANT<br><span class="hljs-attribute">mydb</span>=# alter<span class="hljs-built_in"> default </span>privileges <span class="hljs-keyword">for</span> role postgres <span class="hljs-keyword">in</span> schema public grant select on tables <span class="hljs-keyword">to</span> readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的表可读<br>ALTER<span class="hljs-built_in"> DEFAULT </span>PRIVILEGES<br><span class="hljs-attribute">mydb</span>=# alter<span class="hljs-built_in"> default </span>privileges <span class="hljs-keyword">for</span> role postgres  <span class="hljs-keyword">in</span> schema public grant execute on functions <span class="hljs-keyword">to</span> readonly;   -- 赋予readonly对public模式下之后对postgres用户新建的函数可执行<br>ALTER<span class="hljs-built_in"> DEFAULT </span>PRIVILEGES<br><span class="hljs-attribute">mydb</span>=# alter<span class="hljs-built_in"> default </span>privileges <span class="hljs-keyword">for</span> role postgres  <span class="hljs-keyword">in</span> schema public grant select on sequences <span class="hljs-keyword">to</span> readonly;    - 赋予readonly对public模式下之后对postgres用户新建的序列可读<br>ALTER<span class="hljs-built_in"> DEFAULT </span>PRIVILEGES<br></code></pre></td></tr></table></figure></p>
<h1 id="创建读写角色"><a href="#创建读写角色" class="headerlink" title="创建读写角色"></a>创建读写角色</h1><p>只对table, sequence, function 做了处理， 如type, procedure等类似<br><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">mydb</span>=# grant all on SCHEMA public <span class="hljs-keyword">to</span> readwrite ;            -- 赋予readwrite对public模式下当前存在的表可读写<br>GRANT<br><span class="hljs-attribute">mydb</span>=# grant ALL  on ALL tables <span class="hljs-keyword">in</span> schema public <span class="hljs-keyword">to</span> readwrite ;<br>GRANT<br><span class="hljs-attribute">mydb</span>=# grant ALL on ALL sequences <span class="hljs-keyword">in</span> schema public <span class="hljs-keyword">to</span> readwrite ;<br>GRANT<br><span class="hljs-attribute">mydb</span>=# grant ALL on ALL functions <span class="hljs-keyword">in</span> schema public <span class="hljs-keyword">to</span> readwrite ;<br>GRANT<br><span class="hljs-attribute">mydb</span>=# alter<span class="hljs-built_in"> default </span>privileges <span class="hljs-keyword">for</span> role postgres  <span class="hljs-keyword">in</span> schema public grant all on tables <span class="hljs-keyword">to</span> readwrite;<br>ALTER<span class="hljs-built_in"> DEFAULT </span>PRIVILEGES<br><span class="hljs-attribute">mydb</span>=# alter<span class="hljs-built_in"> default </span>privileges <span class="hljs-keyword">for</span> role postgres <span class="hljs-keyword">in</span> schema public grant all on sequences <span class="hljs-keyword">to</span> readwrite;<br>ALTER<span class="hljs-built_in"> DEFAULT </span>PRIVILEGES<br><span class="hljs-attribute">mydb</span>=# alter<span class="hljs-built_in"> default </span>privileges <span class="hljs-keyword">for</span> role postgres <span class="hljs-keyword">in</span> schema public grant all on functions <span class="hljs-keyword">to</span> readwrite;<br>ALTER<span class="hljs-built_in"> DEFAULT </span>PRIVILEGES<br><br></code></pre></td></tr></table></figure></p>
<h1 id="readonly-权限测试"><a href="#readonly-权限测试" class="headerlink" title="readonly 权限测试"></a>readonly 权限测试</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">mydb=# <span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span> user1;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span><br>mydb=# <span class="hljs-keyword">set</span> <span class="hljs-keyword">role</span> user1;<br><span class="hljs-keyword">SET</span><br>mydb=&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-built_in">public</span>.test1;<br>ERROR:  permission denied <span class="hljs-keyword">for</span> <span class="hljs-keyword">schema</span> <span class="hljs-built_in">public</span><br><span class="hljs-type">LINE</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-built_in">public</span>.test1;<br>                      ^<br>mydb=&gt; <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-built_in">public</span>.test1 <span class="hljs-keyword">select</span> <span class="hljs-number">2</span>;<br>ERROR:  permission denied <span class="hljs-keyword">for</span> <span class="hljs-keyword">schema</span> <span class="hljs-built_in">public</span><br><span class="hljs-type">LINE</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-built_in">public</span>.test1 <span class="hljs-keyword">select</span> <span class="hljs-number">2</span>;<br>                    ^<br>mydb=&gt; <span class="hljs-keyword">set</span> <span class="hljs-keyword">role</span> postgres;<br><span class="hljs-keyword">SET</span><br>mydb=# <span class="hljs-keyword">grant</span> readonly <span class="hljs-keyword">to</span> user1 ;<br><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ROLE</span><br>mydb=# <span class="hljs-keyword">set</span> <span class="hljs-keyword">role</span> user1;<br><span class="hljs-keyword">SET</span><br>mydb=&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-built_in">public</span>.test1;<br> id <br><span class="hljs-comment">----</span><br>  <span class="hljs-number">1</span><br>(<span class="hljs-number">1</span> <span class="hljs-keyword">row</span>)<br><br>mydb=&gt; <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-built_in">public</span>.test1 <span class="hljs-keyword">select</span> <span class="hljs-number">2</span>;<br>ERROR:  permission denied <span class="hljs-keyword">for</span> <span class="hljs-keyword">table</span> test1<br>mydb=&gt; <br>mydb=# <span class="hljs-keyword">select</span> <span class="hljs-number">2</span> <span class="hljs-keyword">into</span> test2;<br><span class="hljs-keyword">SELECT</span> <span class="hljs-number">1</span><br>mydb=# <span class="hljs-keyword">set</span> <span class="hljs-keyword">role</span> user1;<br><span class="hljs-keyword">SET</span><br>mydb=&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> test2;<br> ?<span class="hljs-keyword">column</span>? <br><span class="hljs-comment">----------</span><br>        <span class="hljs-number">2</span><br>(<span class="hljs-number">1</span> <span class="hljs-keyword">row</span>)<br><br>mydb=&gt; <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test2 <span class="hljs-keyword">select</span> <span class="hljs-number">3</span>;<br>ERROR:  permission denied <span class="hljs-keyword">for</span> <span class="hljs-keyword">table</span> test2<br>mydb=&gt; <br><br></code></pre></td></tr></table></figure>
<h1 id="readwrite权限测试"><a href="#readwrite权限测试" class="headerlink" title="readwrite权限测试"></a>readwrite权限测试</h1><figure class="highlight pgsql"><table><tr><td class="code"><pre><code class="hljs pgsql">mydb=# <span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span> user2;<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">ROLE</span><br>mydb=# <span class="hljs-keyword">set</span> <span class="hljs-keyword">role</span> user2;<br><span class="hljs-keyword">SET</span><br>mydb=&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-built_in">public</span>.test1;<br>ERROR:  permission denied <span class="hljs-keyword">for</span> <span class="hljs-keyword">schema</span> <span class="hljs-built_in">public</span><br><span class="hljs-type">LINE</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-built_in">public</span>.test1;<br>                      ^<br>mydb=&gt; <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-built_in">public</span>.test2 <span class="hljs-keyword">select</span> <span class="hljs-number">2</span>;<br>ERROR:  permission denied <span class="hljs-keyword">for</span> <span class="hljs-keyword">schema</span> <span class="hljs-built_in">public</span><br><span class="hljs-type">LINE</span> <span class="hljs-number">1</span>: <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-built_in">public</span>.test2 <span class="hljs-keyword">select</span> <span class="hljs-number">2</span>;<br>                    ^<br>mydb=&gt; <span class="hljs-keyword">set</span> <span class="hljs-keyword">role</span> postgres;<br><span class="hljs-keyword">SET</span><br>mydb=# <span class="hljs-keyword">grant</span> readwrite <span class="hljs-keyword">to</span> user2;<br><span class="hljs-keyword">GRANT</span> <span class="hljs-keyword">ROLE</span><br>mydb=# <span class="hljs-keyword">set</span> <span class="hljs-keyword">role</span> user2;<br><span class="hljs-keyword">SET</span><br>mydb=&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> <span class="hljs-built_in">public</span>.test1;<br> id <br><span class="hljs-comment">----</span><br>  <span class="hljs-number">1</span><br>(<span class="hljs-number">1</span> <span class="hljs-keyword">row</span>)<br><br>mydb=&gt; <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-built_in">public</span>.test2 <span class="hljs-keyword">select</span> <span class="hljs-number">2</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span><br>mydb=&gt; <span class="hljs-keyword">set</span> <span class="hljs-keyword">role</span> postgres;<br><span class="hljs-keyword">SET</span><br>mydb=# <span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> test3(id <span class="hljs-type">int</span>);<br><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span><br>mydb=# <span class="hljs-keyword">set</span> <span class="hljs-keyword">role</span> user2;<br><span class="hljs-keyword">SET</span><br>mydb=&gt; <span class="hljs-keyword">select</span> * <span class="hljs-keyword">from</span> test3;<br> id <br><span class="hljs-comment">----</span><br>(<span class="hljs-number">0</span> <span class="hljs-keyword">rows</span>)<br><br>mydb=&gt; <span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> test3 <span class="hljs-keyword">select</span> <span class="hljs-number">1</span>;<br><span class="hljs-keyword">INSERT</span> <span class="hljs-number">0</span> <span class="hljs-number">1</span><br>mydb=&gt; <br><br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
        <tag>role</tag>
        <tag>权限</tag>
      </tags>
  </entry>
  <entry>
    <title>Zabbix编译安装</title>
    <url>/zabbix/zabbix%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</url>
    <content><![CDATA[<h1 id="新建帐号"><a href="#新建帐号" class="headerlink" title="新建帐号"></a>新建帐号</h1><figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">groupadd</span> <span class="hljs-string">zabbix</span><br><span class="hljs-attr">useradd</span> <span class="hljs-string">-g zabbix zabbix</span><br></code></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h1><figure class="highlight apache"><table><tr><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">sudo</span> apt install libsnmp-dev<br><span class="hljs-attribute">sudo</span> apt install libssh<span class="hljs-number">2</span>-<span class="hljs-number">1</span>*<br><span class="hljs-attribute">sudo</span> apt install libopenipmi-dev<br><span class="hljs-attribute">sudo</span> apt install libldap<span class="hljs-number">2</span>-dev<br><span class="hljs-attribute">sudo</span> apt install libevent-dev<br><span class="hljs-attribute">sudo</span> apt install curl<br><span class="hljs-attribute">sudo</span> apt install php-pgsql<br><span class="hljs-attribute">sudo</span> apt install php<span class="hljs-number">7</span>.<span class="hljs-number">2</span>-xml<br><span class="hljs-attribute">sudo</span> apt install apache<span class="hljs-number">2</span><br><span class="hljs-attribute">sudo</span> apt install php<span class="hljs-number">7</span>.<span class="hljs-number">2</span>-bcmath<br><span class="hljs-attribute">sudo</span> apt install php<span class="hljs-number">7</span>.<span class="hljs-number">2</span>-mbstring<br><span class="hljs-attribute">sudo</span> apt install php<span class="hljs-number">7</span>.<span class="hljs-number">2</span>-ldap<br><span class="hljs-attribute">sudo</span> apt install php<span class="hljs-number">7</span>.<span class="hljs-number">0</span>-snmp<br></code></pre></td></tr></table></figure>
<h1 id="下载-amp-amp-编译-amp-amp-安装"><a href="#下载-amp-amp-编译-amp-amp-安装" class="headerlink" title="下载  &amp;&amp; 编译 &amp;&amp; 安装"></a>下载  &amp;&amp; 编译 &amp;&amp; 安装</h1><figure class="highlight jboss-cli"><table><tr><td class="code"><pre><code class="hljs jboss-cli">useradd -m zabbix -d <span class="hljs-string">/home/zabbix</span><br>su - zabbix<br>wget https:<span class="hljs-string">//cdn.zabbix.com/zabbix/sources/stable/4.0/zabbix-4.0.2.tar.gz</span><br>tar -zxvf zabbix-4.0.2.tar.gz<br><span class="hljs-keyword">cd</span> zabbix-4.0.2/<br><span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/home/zabbix/release</span> <span class="hljs-params">--enable-server</span> <span class="hljs-params">--enable-proxy</span> <span class="hljs-params">--enable-agent</span> <span class="hljs-params">--enable-ipv6</span> <span class="hljs-params">--with-postgresql=/opt/pg11/bin/pg_config</span> <span class="hljs-params">--with-net-snmp</span> <span class="hljs-params">--with-ssh2</span> <span class="hljs-params">--with-openipmi</span> <span class="hljs-params">--with-ldap</span> <span class="hljs-params">--with-libcurl</span> <span class="hljs-params">--with-iconv</span> <span class="hljs-params">--enable-bcmath</span> <span class="hljs-params">--enable-mbstring</span>  <span class="hljs-params">--with-gd</span>  <span class="hljs-params">--with-png-dir</span> <span class="hljs-params">--with-jpeg-dir</span> <span class="hljs-params">--with-freetype-dir</span><br>make &amp;&amp; make install<br></code></pre></td></tr></table></figure>
<h1 id="配置zabbix"><a href="#配置zabbix" class="headerlink" title="配置zabbix"></a>配置zabbix</h1><p>cd /home/zabbix/release/sbin<br>vim ../etc/zabbix_server.conf 填写正确DB内容<br><figure class="highlight ini"><table><tr><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">DBHost</span>=DBHost<br><span class="hljs-attr">DBName</span>=DBName<br><span class="hljs-attr">DBUser</span>=DBUser<br><span class="hljs-attr">DBPassword</span>=<span class="hljs-string">&#x27;DBPassword&#x27;</span><br></code></pre></td></tr></table></figure></p>
<h1 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h1><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">./zabbix_server<br><span class="hljs-regexp">/etc/i</span>nit.d/apache2 start<br>sudo mkdir <span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/</span>zabbix<br>sudo chown -R zabbix:zabbix<br>cp -fr <span class="hljs-regexp">/home/</span>zabbix<span class="hljs-regexp">/zabbix-4.0.2/</span>frontends<span class="hljs-regexp">/php/</span>* <span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/</span>zabbix<br><br></code></pre></td></tr></table></figure>
<p>页面就可以登陆了。</p>
<h1 id="配置zabbix-1"><a href="#配置zabbix-1" class="headerlink" title="配置zabbix"></a>配置zabbix</h1><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span>hostname<span class="hljs-regexp">/zabbix/</span>setup.php<br></code></pre></td></tr></table></figure>
<p><img data-src="/images/zabbix01.png" alt="zabbix01"></p>
<p>下一步，修改php配置保证所有状态直到OK</p>
<p><img data-src="/images/zabbix02.png" alt="zabbix02"></p>
<h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><p>PHP databases support off Fail<br><figure class="highlight awk"><table><tr><td class="code"><pre><code class="hljs awk">extension=<span class="hljs-regexp">/opt/</span>remi<span class="hljs-regexp">/php72/</span>root<span class="hljs-regexp">/usr/</span>lib64<span class="hljs-regexp">/php/m</span>odules/pgsql.so<br></code></pre></td></tr></table></figure></p>
]]></content>
      <categories>
        <category>zabbix</category>
      </categories>
      <tags>
        <tag>zabbix</tag>
      </tags>
  </entry>
  <entry>
    <title>利用PostgreSQL LATERAL完成行列转换</title>
    <url>/PostgreSQL/PostgreSQL%E8%A1%8C%E5%88%97%E8%BD%AC%E6%8D%A2/</url>
    <content><![CDATA[<p>利用PostgreSQL LATERAL完成行列转换.</p>
<a id="more"></a>
<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h1><figure class="highlight coq"><table><tr><td class="code"><pre><code class="hljs coq">原始表数据如下：<br><br>name| <span class="hljs-type">English</span> | <span class="hljs-type">Physics</span> | <span class="hljs-type">Math</span><br>------+---------+---------+------<br>Simon |      <span class="hljs-type">90</span> |      <span class="hljs-type">76</span> |   <span class="hljs-type">79</span><br>Lucy  |     <span class="hljs-type">100</span> |      <span class="hljs-type">90</span> |   <span class="hljs-type">85</span><br>Lily  |      <span class="hljs-type">95</span> |      <span class="hljs-type">81</span> |   <span class="hljs-type">84</span><br>David |     <span class="hljs-type">100</span> |      <span class="hljs-type">86</span> |   <span class="hljs-type">89</span><br><br>转换为<br>  name  | <span class="hljs-type">subject</span> | <span class="hljs-type">score</span><br>--------+---------+-------<br> Simon  | <span class="hljs-type">english</span> |    <span class="hljs-type">90</span><br> Simon  | <span class="hljs-type">physics</span> |    <span class="hljs-type">76</span><br> Simon  | <span class="hljs-type">math</span>    |    <span class="hljs-type">79</span><br> Lucy   | <span class="hljs-type">english</span> |   <span class="hljs-type">100</span><br> Lucy   | <span class="hljs-type">physics</span> |    <span class="hljs-type">90</span><br> Lucy   | <span class="hljs-type">math</span>    |    <span class="hljs-type">85</span><br> Lily   | <span class="hljs-type">english</span> |    <span class="hljs-type">95</span><br> Lily   | <span class="hljs-type">physics</span> |    <span class="hljs-type">81</span><br> Lily   | <span class="hljs-type">math</span>    |    <span class="hljs-type">84</span><br> David  | <span class="hljs-type">english</span> |   <span class="hljs-type">100</span><br> David  | <span class="hljs-type">physics</span> |    <span class="hljs-type">86</span><br> David  | <span class="hljs-type">math</span>    |    <span class="hljs-type">89</span><br></code></pre></td></tr></table></figure>
<h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight angelscript"><table><tr><td class="code"><pre><code class="hljs angelscript">create table test(name text, english <span class="hljs-built_in">int</span>, physics <span class="hljs-built_in">int</span>, math <span class="hljs-built_in">int</span>);<br>\copy test <span class="hljs-keyword">from</span> stdin with delimiter <span class="hljs-string">&#x27;|&#x27;</span><br> Simon  |      <span class="hljs-number">90</span> |      <span class="hljs-number">76</span> |   <span class="hljs-number">79</span><br> Lucy   |     <span class="hljs-number">100</span> |      <span class="hljs-number">90</span> |   <span class="hljs-number">85</span><br> Lily   |      <span class="hljs-number">95</span> |      <span class="hljs-number">81</span> |   <span class="hljs-number">84</span><br> David  |     <span class="hljs-number">100</span> |      <span class="hljs-number">86</span> |   <span class="hljs-number">89</span><br>\.<br></code></pre></td></tr></table></figure>
<h1 id="使用union-all"><a href="#使用union-all" class="headerlink" title="使用union all"></a>使用union all</h1><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">mydb</span>=# explain analyze  select name, max(english) <span class="hljs-keyword">from</span> test<span class="hljs-built_in"> group </span>by name union all select name, max(physics) <span class="hljs-keyword">from</span> test<span class="hljs-built_in"> group </span>by name union all select name, max(math) <span class="hljs-keyword">from</span> test<span class="hljs-built_in"> group </span>by name;<br>                                                      QUERY PLAN<br>----------------------------------------------------------------------------------------------------------------------<br> Append  (<span class="hljs-attribute">cost</span>=78.10..249.30 <span class="hljs-attribute">rows</span>=600 <span class="hljs-attribute">width</span>=36) (actual <span class="hljs-attribute">time</span>=0.071..0.151 <span class="hljs-attribute">rows</span>=12 <span class="hljs-attribute">loops</span>=1)<br>   -&gt;  HashAggregate  (<span class="hljs-attribute">cost</span>=78.10..80.10 <span class="hljs-attribute">rows</span>=200 <span class="hljs-attribute">width</span>=36) (actual <span class="hljs-attribute">time</span>=0.069..0.078 <span class="hljs-attribute">rows</span>=4 <span class="hljs-attribute">loops</span>=1)<br>        <span class="hljs-built_in"> Group </span>Key: test.name<br>         -&gt;  Seq Scan on test  (<span class="hljs-attribute">cost</span>=0.00..55.40 <span class="hljs-attribute">rows</span>=4540 <span class="hljs-attribute">width</span>=36) (actual <span class="hljs-attribute">time</span>=0.029..0.033 <span class="hljs-attribute">rows</span>=4 <span class="hljs-attribute">loops</span>=1)<br>   -&gt;  HashAggregate  (<span class="hljs-attribute">cost</span>=78.10..80.10 <span class="hljs-attribute">rows</span>=200 <span class="hljs-attribute">width</span>=36) (actual <span class="hljs-attribute">time</span>=0.027..0.035 <span class="hljs-attribute">rows</span>=4 <span class="hljs-attribute">loops</span>=1)<br>        <span class="hljs-built_in"> Group </span>Key: test_1.name<br>         -&gt;  Seq Scan on test test_1  (<span class="hljs-attribute">cost</span>=0.00..55.40 <span class="hljs-attribute">rows</span>=4540 <span class="hljs-attribute">width</span>=36) (actual <span class="hljs-attribute">time</span>=0.009..0.012 <span class="hljs-attribute">rows</span>=4 <span class="hljs-attribute">loops</span>=1)<br>   -&gt;  HashAggregate  (<span class="hljs-attribute">cost</span>=78.10..80.10 <span class="hljs-attribute">rows</span>=200 <span class="hljs-attribute">width</span>=36) (actual <span class="hljs-attribute">time</span>=0.022..0.029 <span class="hljs-attribute">rows</span>=4 <span class="hljs-attribute">loops</span>=1)<br>        <span class="hljs-built_in"> Group </span>Key: test_2.name<br>         -&gt;  Seq Scan on test test_2  (<span class="hljs-attribute">cost</span>=0.00..55.40 <span class="hljs-attribute">rows</span>=4540 <span class="hljs-attribute">width</span>=36) (actual <span class="hljs-attribute">time</span>=0.007..0.010 <span class="hljs-attribute">rows</span>=4 <span class="hljs-attribute">loops</span>=1)<br> Planning Time: 0.511 ms<br> Execution Time: 0.378 ms<br>(12 rows)<br><br><span class="hljs-attribute">mydb</span>=#<br></code></pre></td></tr></table></figure>
<h1 id="自连接"><a href="#自连接" class="headerlink" title="自连接"></a>自连接</h1><figure class="highlight routeros"><table><tr><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">mydb</span>=# explain analyze SELECT t.name,s.* <span class="hljs-keyword">from</span> test t JOIN LATERAL(VALUES(<span class="hljs-string">&#x27;english&#x27;</span>,t.english ), (<span class="hljs-string">&#x27;physics&#x27;</span>,t.physics), (<span class="hljs-string">&#x27;math&#x27;</span>,t.math)) s(subject, score) on <span class="hljs-literal">true</span>;<br>                                                  QUERY PLAN<br>--------------------------------------------------------------------------------------------------------------<br> Nested Loop  (<span class="hljs-attribute">cost</span>=0.00..361.85 <span class="hljs-attribute">rows</span>=13620 <span class="hljs-attribute">width</span>=68) (actual <span class="hljs-attribute">time</span>=0.038..0.073 <span class="hljs-attribute">rows</span>=12 <span class="hljs-attribute">loops</span>=1)<br>   -&gt;  Seq Scan on test t  (<span class="hljs-attribute">cost</span>=0.00..55.40 <span class="hljs-attribute">rows</span>=4540 <span class="hljs-attribute">width</span>=44) (actual <span class="hljs-attribute">time</span>=0.021..0.025 <span class="hljs-attribute">rows</span>=4 <span class="hljs-attribute">loops</span>=1)<br>   -&gt;  Values Scan on <span class="hljs-string">&quot;*VALUES*&quot;</span>  (<span class="hljs-attribute">cost</span>=0.00..0.04 <span class="hljs-attribute">rows</span>=3 <span class="hljs-attribute">width</span>=36) (actual <span class="hljs-attribute">time</span>=0.003..0.007 <span class="hljs-attribute">rows</span>=3 <span class="hljs-attribute">loops</span>=4)<br> Planning Time: 0.209 ms<br> Execution Time: 0.128 ms<br>(5 rows)<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>PostgreSQL</tag>
        <tag>行列转换</tag>
        <tag>LATERAL</tag>
        <tag>自连接</tag>
      </tags>
  </entry>
  <entry>
    <title>psql显示风格设置</title>
    <url>/PostgreSQL/psql%E6%98%BE%E7%A4%BA%E9%A3%8E%E6%A0%BC%E8%AE%BE%E7%BD%AE/</url>
    <content><![CDATA[<h1 id="MySQL风格"><a href="#MySQL风格" class="headerlink" title="MySQL风格"></a>MySQL风格</h1><figure class="highlight asciidoc"><table><tr><td class="code"><pre><code class="hljs asciidoc">\pset border 2<br><span class="hljs-code"> </span><br>postgres=# select * from test;<br><span class="hljs-code">+----+</span>----+<br>| id | c1 |<br><span class="hljs-code">+----+</span>----+<br>|  1 |  1 |<br>|  2 |  2 |<br><span class="hljs-code">+----+</span>----+<br>(2 rows)<br><span class="hljs-code"> </span><br>postgres=#<br><span class="hljs-code"> </span><br>--------------------------------------<br><span class="hljs-code"> </span><br>mysql&gt; select * from t;<br><span class="hljs-code">+------+</span><br>| id   |<br><span class="hljs-code">+------+</span><br>|    1 |<br><span class="hljs-code">+------+</span><br>1 row in set (0.01 sec)<br><span class="hljs-code"> </span><br>mysql&gt;<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>PostgreSQL</category>
      </categories>
      <tags>
        <tag>psql</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/uncategorized/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>Linux vim常用配置</title>
    <url>/vim/linux%E9%85%8D%E7%BD%AEvim/</url>
    <content><![CDATA[<p>列举一些有用的vim小功能, 能有效的避免重复造轮子.</p>
<a id="more"></a>
<h1 id="vim新建文件时-按F4既可以添加作者信息"><a href="#vim新建文件时-按F4既可以添加作者信息" class="headerlink" title="vim新建文件时, 按F4既可以添加作者信息"></a>vim新建文件时, 按F4既可以添加作者信息</h1><p>~/.vimrc中追加如下内容</p>
<figure class="highlight scilab"><table><tr><td class="code"><pre><code class="hljs scilab"><span class="hljs-string">&quot;进行版权声明的设置</span><br><span class="hljs-string">&quot;</span><span class="hljs-string">&quot;添加或更新头</span><br><span class="hljs-string">map &lt;F4&gt; :call TitleDet() &lt;cr&gt;&#x27;</span>s<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AddTitle</span><span class="hljs-params">()</span></span><br>    call append(<span class="hljs-number">0</span>,<span class="hljs-string">&quot;/********************************************************&quot;</span>)<br>    call append(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;* Author        : ×××&quot;</span>)<br>    call append(<span class="hljs-number">2</span>,<span class="hljs-string">&quot;* Email         : ×××@×××.com&quot;</span>)<br>    call append(<span class="hljs-number">3</span>,<span class="hljs-string">&quot;* Last modified : &quot;</span>.strftime(<span class="hljs-string">&quot;%Y-%m-%d %H:%M&quot;</span>))<br>    call append(<span class="hljs-number">4</span>,<span class="hljs-string">&quot;* Filename      : &quot;</span>.expand(<span class="hljs-string">&quot;%:t&quot;</span>))<br>    call append(<span class="hljs-number">5</span>,<span class="hljs-string">&quot;* Description   : &quot;</span>)<br>    call append(<span class="hljs-number">6</span>,<span class="hljs-string">&quot;*********************************************************/&quot;</span>)<br>    echohl WarningMsg | echo <span class="hljs-string">&quot;Successful in adding the copyright.&quot;</span> | echohl None<br>endf<br><span class="hljs-string">&quot;更新最近修改时间和文件名</span><br><span class="hljs-string">function UpdateTitle()</span><br><span class="hljs-string">    normal m&#x27;</span><br>    execute <span class="hljs-string">&#x27;/# *Last modified:/s@:.*$@\=strftime(&quot;</span>:\t%Y-%m-%d %H:%M<span class="hljs-string">&quot;)@&#x27;</span><br>    normal <span class="hljs-string">&#x27;&#x27;</span><br>    normal mk                                         <br>    execute <span class="hljs-string">&#x27;/# *Filename:/s@:.*$@\=&quot;</span>:\t\t<span class="hljs-string">&quot;.expand(&quot;</span>%:t<span class="hljs-string">&quot;)@&#x27;</span><br>    execute <span class="hljs-string">&quot;noh&quot;</span>                               <br>    normal <span class="hljs-string">&#x27;k</span><br><span class="hljs-string">    echohl WarningMsg | echo &quot;</span>Successful in updating the copy right | echohl None<br><span class="hljs-keyword">endfunction</span><br><span class="hljs-string">&quot;判断前10行代码里面，是否有Last modified这个单词，</span><br><span class="hljs-string">&quot;</span>如果没有的话，代表没有添加过作者信息，需要新添加；<br><span class="hljs-string">&quot;如果有的话，那么只需要更新即可</span><br><span class="hljs-string">function TitleDet()     </span><br><span class="hljs-string">    let n = 1</span><br><span class="hljs-string">    &quot;</span>默认为添加<br>    <span class="hljs-keyword">while</span> n &lt; <span class="hljs-number">7</span><br>        let line = getline(n)<br>        <span class="hljs-keyword">if</span> line =~ <span class="hljs-string">&#x27;^\#\s*\S*Last\smodified:\S*.*$&#x27;</span><br>            call UpdateTitle()<br>            <span class="hljs-keyword">return</span><br>        endif<br>        let n = n+<span class="hljs-number">1</span><br>    endwhile<br>    call AddTitle()<br><span class="hljs-keyword">endfunction</span><br></code></pre></td></tr></table></figure>
<h1 id="vim新建python或者bash脚本添加固定内容"><a href="#vim新建python或者bash脚本添加固定内容" class="headerlink" title="vim新建python或者bash脚本添加固定内容"></a>vim新建python或者bash脚本添加固定内容</h1><p>~/.vimrc中追加如下内容</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">autocmd</span> BufNewFile *.<span class="hljs-keyword">py</span>,*.<span class="hljs-keyword">sh</span>, exec <span class="hljs-string">&quot;:call SetTitle()&quot;</span><br><span class="hljs-keyword">let</span> $author_name = <span class="hljs-string">&quot;taot.jin&quot;</span><br><span class="hljs-keyword">let</span> $author_email = <span class="hljs-string">&quot;taot.jin@qunar.com&quot;</span><br><br>func SetTitle()<br>    <span class="hljs-keyword">if</span> &amp;<span class="hljs-keyword">filetype</span> == <span class="hljs-string">&#x27;sh&#x27;</span><br>    <span class="hljs-keyword">call</span> <span class="hljs-built_in">setline</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;\###################################################################&quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>), <span class="hljs-string">&quot;\# File Name: &quot;</span>.<span class="hljs-built_in">expand</span>(<span class="hljs-string">&quot;%&quot;</span>))<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>, <span class="hljs-string">&quot;\# Author: &quot;</span>.$author_name)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">2</span>, <span class="hljs-string">&quot;\# mail: &quot;</span>.$author_email)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">3</span>, <span class="hljs-string">&quot;\# Created Time: &quot;</span>.<span class="hljs-built_in">strftime</span>(<span class="hljs-string">&quot;%c&quot;</span>))<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">4</span>, <span class="hljs-string">&quot;\#=============================================================&quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">5</span>, <span class="hljs-string">&quot;\#!/bin/bash&quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">6</span>, <span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">else</span><br>    <span class="hljs-keyword">call</span> <span class="hljs-built_in">setline</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;\###################################################################&quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>), <span class="hljs-string">&quot;\# File Name: &quot;</span>.<span class="hljs-built_in">expand</span>(<span class="hljs-string">&quot;%&quot;</span>))<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>, <span class="hljs-string">&quot;\# Author: &quot;</span>.$author_name)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">2</span>, <span class="hljs-string">&quot;\# mail: &quot;</span>.$author_email)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">3</span>, <span class="hljs-string">&quot;\# Created Time: &quot;</span>.<span class="hljs-built_in">strftime</span>(<span class="hljs-string">&quot;%c&quot;</span>))<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">4</span>, <span class="hljs-string">&quot;\#=============================================================&quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">5</span>, <span class="hljs-string">&quot;\#!/usr/bin/python&quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">5</span>, <span class="hljs-string">&quot;\# -*- coding: utf-8 -*-&quot;</span>)<br>    <span class="hljs-string">&quot;call append(line(&quot;</span>.<span class="hljs-string">&quot;)+6, &quot;</span><span class="hljs-comment">&quot;)</span><br>    <span class="hljs-keyword">endif</span><br>endfunc<br></code></pre></td></tr></table></figure>
<h1 id="vim新建markdown文件时添加固定信息"><a href="#vim新建markdown文件时添加固定信息" class="headerlink" title="vim新建markdown文件时添加固定信息"></a>vim新建markdown文件时添加固定信息</h1><p>~/.vimrc中追加如下内容</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">autocmd</span> BufNewFile *.md, exec <span class="hljs-string">&quot;:call SetTitle1()&quot;</span><br><span class="hljs-keyword">let</span> $author_name = <span class="hljs-string">&quot;taot.jin&quot;</span><br><span class="hljs-keyword">let</span> $author_email = <span class="hljs-string">&quot;taot.jin@qunar.com&quot;</span><br><br>func SetTitle1()<br>    <span class="hljs-keyword">call</span> <span class="hljs-built_in">setline</span>(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;---&quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>), <span class="hljs-string">&quot;title: &quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">1</span>, <span class="hljs-string">&quot;date: &quot;</span>.<span class="hljs-built_in">strftime</span>(<span class="hljs-string">&quot;%Y-%m-%d&quot;</span>))<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">2</span>, <span class="hljs-string">&quot;tags: &quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">3</span>, <span class="hljs-string">&quot;categories: &quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">4</span>, <span class="hljs-string">&quot;top: &quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">5</span>, <span class="hljs-string">&quot;description: &quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">6</span>, <span class="hljs-string">&quot;password: &quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">7</span>, <span class="hljs-string">&quot;&quot;</span>)<br>    <span class="hljs-keyword">call</span> <span class="hljs-keyword">append</span>(<span class="hljs-built_in">line</span>(<span class="hljs-string">&quot;.&quot;</span>)+<span class="hljs-number">8</span>, <span class="hljs-string">&quot;---&quot;</span>)<br>endfunc<br></code></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>vim</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>vim</tag>
      </tags>
  </entry>
</search>
